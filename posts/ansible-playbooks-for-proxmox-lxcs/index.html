<!doctype html><html lang=en><head><title>Ansible Playbooks for Proxmox and LXCs Part 1 :: reticulating splines</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Part one of the series covers setting up Ansible, creating a role with some tasks, and writing an LXC management playbook."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://sbarbett.github.io/reticulating-splines/posts/ansible-playbooks-for-proxmox-lxcs/><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/buttons.min.86f6b4c106b6c6eb690ae5203d36b442c1f66f718ff4e8164fa86cf6c61ad641.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/code.min.d529ea4b2fb8d34328d7d31afc5466d5f7bc2f0bc9abdd98b69385335d7baee4.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/fonts.min.5bb7ed13e1d00d8ff39ea84af26737007eb5051b157b86fc24487c94f3dc8bbe.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/footer.min.eb8dfc2c6a7eafa36cd3ba92d63e69e849e2200e0002a228d137f236b09ecd75.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/header.min.75c7eb0e2872d95ff48109c6647d0223a38db52e2561dd87966eb5fc7c6bdac6.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/main.min.775ac2af004d44c22a6d000fbd1d9af529642f5cef27399d0280d180af2c2e9b.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/menu.min.310d32205bdedd6f43144e3c3273c9deecd238eba5f9108db5ea96ca0cfbe377.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/pagination.min.bbb986dbce00a5ce5aca0504b7925fc1c581992a4bf57f163e5d69cc1db7d836.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/post.min.ad50c7f4d00e7975918f37fc74c6029e1959a40d66fb5b2c6564a8715e985573.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/syntax.min.e9ab635cf918bc84b901eb65c0b2caa74c9544245e3647c1af5c129896ef276e.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/terminal.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/style.css><link rel="shortcut icon" href=https://sbarbett.github.io/reticulating-splines/favicon.png><link rel=apple-touch-icon href=https://sbarbett.github.io/reticulating-splines/apple-touch-icon.png><meta name=twitter:card content="summary"><meta name=twitter:site content="https://shane.barbetta.me"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Ansible Playbooks for Proxmox and LXCs Part 1"><meta property="og:description" content="Part one of the series covers setting up Ansible, creating a role with some tasks, and writing an LXC management playbook."><meta property="og:url" content="https://sbarbett.github.io/reticulating-splines/posts/ansible-playbooks-for-proxmox-lxcs/"><meta property="og:site_name" content="reticulating splines"><meta property="og:image" content="https://sbarbett.github.io/reticulating-splines/og-image.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2025-02-09 00:00:00 +0000 UTC"></head><body><div class="container full"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>reticulating splines</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=https://shane.barbetta.me>about</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=https://shane.barbetta.me>about</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://sbarbett.github.io/reticulating-splines/posts/ansible-playbooks-for-proxmox-lxcs/>Ansible Playbooks for Proxmox and LXCs Part 1</a></h1><div class=post-meta><time class=post-date>2025-02-09</time></div><span class=post-tags>#<a href=https://sbarbett.github.io/reticulating-splines/tags/proxmox/>proxmox</a>&nbsp;
#<a href=https://sbarbett.github.io/reticulating-splines/tags/ansible/>ansible</a>&nbsp;</span><div class=post-content><div><h1 id=ansible-playbooks-for-proxmox-and-lxcs---part-1>Ansible Playbooks for Proxmox and LXCs - Part 1<a href=#ansible-playbooks-for-proxmox-and-lxcs---part-1 class=hanchor arialabel=Anchor>#</a></h1><p>Over the past week, I&rsquo;ve been tinkering with Ansible at work, and it got me thinking about how I can use this tool to make life easier in my homelab. Ansible is a way of turning tasks that usually require a bunch of complicated scripting into something more straightforward. Additionally, with collections, you can integrate directly with APIs without having to reinvent the wheel.</p><p>In my homelab, I run a Proxmox server where I deploy Debian-based VMs. Every time I create a new VM, there&rsquo;s an initial setup process that I’ve traditionally handled with a series of shell scripts. These tasks include:</p><ol><li>Updating the repository cache and upgrading packages.</li><li>Creating a non-root user, adding them to sudo (and installing sudo on Debian 12), enabling pubkey authentication while disabling password-based logins, and locking down root SSH access.</li><li>Automatically retrieving the container’s IP address for easy identification and management.</li></ol><p>While these scripts have worked well, I want to streamline the process further by automating not just the in-VM configuration but also the provisioning of the VM itself on Proxmox. Additionally, I&rsquo;m planning to modularize my setup by creating separate playbooks for tasks like Docker installation and custom MOTD configuration.</p><h2 id=setting-up-ansible>Setting Up Ansible<a href=#setting-up-ansible class=hanchor arialabel=Anchor>#</a></h2><p>I install <code>ansible</code> using pip inside a Python virtual environment (<code>venv</code>). This isn’t the only way to install Ansible, but I like to keep everything contained.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir ~/ansible <span style=color:#f92672>&amp;&amp;</span> cd ~/ansible
</span></span><span style=display:flex><span>python3 -m venv venv
</span></span><span style=display:flex><span>source venv/bin/activate
</span></span><span style=display:flex><span>pip3 install ansible
</span></span></code></pre></div><p>After installation, verify it worked correctly:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible --version
</span></span></code></pre></div><h3 id=create-an-inventory-file>Create an Inventory File<a href=#create-an-inventory-file class=hanchor arialabel=Anchor>#</a></h3><p>Create a simple inventory file that defines <code>localhost</code> as your managed host:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo -e <span style=color:#e6db74>&#34;[test_servers]\nlocalhost ansible_connection=local&#34;</span> &gt; ~/ansible/inventory
</span></span></code></pre></div><h3 id=test-connectivity>Test Connectivity<a href=#test-connectivity class=hanchor arialabel=Anchor>#</a></h3><p>Run the following command to verify that Ansible can communicate with your host:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible -i ~/ansible/inventory test_servers -m ping
</span></span></code></pre></div><h4 id=expected-output>Expected Output<a href=#expected-output class=hanchor arialabel=Anchor>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  ❯❯ /home/demo/ansible : ansible -i ~/ansible/inventory test_servers -m ping
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>WARNING<span style=color:#f92672>]</span>: Platform linux on host localhost is using the discovered Python interpreter at /home/demo/ansible/venv/bin/python3.13, but future installation of another Python interpreter
</span></span><span style=display:flex><span>could change the meaning of that path. See https://docs.ansible.com/ansible-core/2.18/reference_appendices/interpreter_discovery.html <span style=color:#66d9ef>for</span> more information.
</span></span><span style=display:flex><span>localhost | SUCCESS <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#e6db74>&#34;/home/demo/ansible/venv/bin/python3.13&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: false,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ping&#34;</span>: <span style=color:#e6db74>&#34;pong&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h4 id=python-interpreter-warning>Python Interpreter Warning<a href=#python-interpreter-warning class=hanchor arialabel=Anchor>#</a></h4><p>You might see a warning about the discovered Python interpreter. To suppress this warning, you can explicitly set the path to your interpreter in your inventory file. Just add these lines:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>all:vars<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>ansible_python_interpreter<span style=color:#f92672>=</span>/home/demo/ansible/venv/bin/python3.13
</span></span></code></pre></div><p>Remember, your username and the Python version in your virtual environment might differ from mine. Use the absolute path shown as <code>discovered_interpreter_python</code> in your output.</p><h4 id=expected-output-after-updating-the-inventory>Expected Output (After Updating the Inventory)<a href=#expected-output-after-updating-the-inventory class=hanchor arialabel=Anchor>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  ❯❯ /home/demo/ansible : ansible -i ~/ansible/inventory test_servers -m ping
</span></span><span style=display:flex><span>localhost | SUCCESS <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: false,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ping&#34;</span>: <span style=color:#e6db74>&#34;pong&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=basics-of-creating-a-proxmox-lxc-using-ansible>Basics of Creating a Proxmox LXC Using Ansible<a href=#basics-of-creating-a-proxmox-lxc-using-ansible class=hanchor arialabel=Anchor>#</a></h2><h3 id=create-a-proxmox-api-token>Create a Proxmox API Token<a href=#create-a-proxmox-api-token class=hanchor arialabel=Anchor>#</a></h3><p>While it’s technically possible to authenticate with your Proxmox instance using your username and password, that’s not a best practice. Instead, create an API token:</p><ol><li>Log in to your Proxmox web console</li><li>Go to <strong>Datacenter</strong>, then under <strong>Permissions</strong>, select <strong>API Tokens</strong></li><li>Click <strong>Add</strong> and give your token an appropriate ID (e.g. <code>ansible</code>)</li></ol><p>I won’t get too deep into how to scope the key with permissions—this guide focuses on using Ansible, not the broader nuances of Proxmox administration.</p><h3 id=create-a-vault>Create a Vault<a href=#create-a-vault class=hanchor arialabel=Anchor>#</a></h3><p>I recommend storing your API token inside an Ansible vault for security. This step is optional but strongly advised.</p><p>Run:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible-vault create proxmox-vault.yml
</span></span></code></pre></div><p>Give your vault a password then, when the text editor opens, add the following lines:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>proxmox_api_user</span>: <span style=color:#e6db74>&#34;user@pam&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>proxmox_api_id</span>: <span style=color:#e6db74>&#34;ansible&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>proxmox_api_secret</span>: <span style=color:#e6db74>&#34;your-token-secret&#34;</span>
</span></span></code></pre></div><p>Here, <code>user</code> is the Proxmox account associated with your token (this could be <code>root</code> if that&rsquo;s what you&rsquo;re using), and <code>ansible</code> is the token ID you set. The <code>secret</code> is your actual API token.</p><p>Once you&rsquo;re done editing, save and exit. Your credentials are now encrypted and saved to <code>proxmox-vault.yml</code>.</p><p>To keep your project organized, create a folder called <code>vars</code> and move the vault file into it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir vars <span style=color:#f92672>&amp;&amp;</span> mv proxmox-vault.yml vars/
</span></span></code></pre></div><h4 id=storing-vault-password>Storing Vault Password<a href=#storing-vault-password class=hanchor arialabel=Anchor>#</a></h4><p>If you don’t want to type <code>--ask-vault-password</code> every time you run a playbook—or if you&rsquo;re planning to automate these playbooks—you can store your vault password in a local file (make sure it’s protected with appropriate Linux permissions):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo <span style=color:#e6db74>&#34;your_vault_password_here&#34;</span> &gt; ~/ansible/vars/.proxmox-vault-pass
</span></span><span style=display:flex><span>chmod <span style=color:#ae81ff>600</span> ~/ansible/vars/.proxmox-vault-pass
</span></span></code></pre></div><p>When running your playbook, pass the vault password file using the <code>--vault-password-file</code> flag.</p><h3 id=install-python-dependencies>Install Python Dependencies<a href=#install-python-dependencies class=hanchor arialabel=Anchor>#</a></h3><p>The Proxmox community modules require <code>requests</code> and <code>proxmoxer</code>. In your <code>~/ansible</code> directory, save the following content as <code>bootstrap.yml</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Bootstrap dependencies</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>localhost</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>connection</span>: <span style=color:#ae81ff>local</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gather_facts</span>: <span style=color:#66d9ef>no</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Install required Python libraries</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ansible.builtin.pip</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>:
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>proxmoxer</span>
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>requests</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
</span></span></code></pre></div><p>Run the playbook with this command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible-playbook -i inventory bootstrap.yml
</span></span></code></pre></div><h4 id=expected-output-1>Expected Output<a href=#expected-output-1 class=hanchor arialabel=Anchor>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>Bootstrap dependencies<span style=color:#f92672>]</span> ************************************************************************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Install required Python libraries<span style=color:#f92672>]</span> *************************************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>localhost<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *******************************************************************************************************************************************************************************
</span></span><span style=display:flex><span>localhost                  : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span></code></pre></div><p><em>Tip:</em> If you want Ansible to be more verbose, you can add the <code>-v</code>, <code>-vv</code> or <code>-vvv</code> flags.</p><h3 id=creating-a-role>Creating a Role<a href=#creating-a-role class=hanchor arialabel=Anchor>#</a></h3><p>I want to keep my tasks modular and reusable across multiple LXCs. Setting up a role takes a bit more work up front, but it&rsquo;s definitely worthwhile in the long run. First, create a directory called <code>roles</code> (if it doesn&rsquo;t already exist) and initialize a new role:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir roles <span style=color:#f92672>&amp;&amp;</span> ansible-galaxy init roles/proxmox_lxc
</span></span></code></pre></div><p>This command automatically creates the file structure needed for your new role. Next, create an <code>ansible.cfg</code> file in your project’s root (e.g. <code>~/ansible</code>) and add the following lines:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>defaults</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>inventory</span> = <span style=color:#a6e22e>inventory</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>roles_path</span> = <span style=color:#a6e22e>roles</span>
</span></span></code></pre></div><p>This configuration tells Ansible where to find your inventory and roles.</p><h3 id=create-lxc-task>Create LXC Task<a href=#create-lxc-task class=hanchor arialabel=Anchor>#</a></h3><p>Now, create a new file called <code>roles/proxmox_lxc/tasks/create.yml</code> and add the following content:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#75715e># roles/proxmox_lxc/tasks/create.yml</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Create LXC container on Proxmox</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>community.general.proxmox</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>api_host</span>: <span style=color:#e6db74>&#34;{{ proxmox_api_host }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>api_user</span>: <span style=color:#e6db74>&#34;{{ proxmox_api_user }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>api_token_id</span>: <span style=color:#e6db74>&#34;{{ proxmox_api_id }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>api_token_secret</span>: <span style=color:#e6db74>&#34;{{ proxmox_api_secret }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>node</span>: <span style=color:#e6db74>&#34;{{ proxmox_node }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>vmid</span>: <span style=color:#e6db74>&#34;{{ container.vmid }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>hostname</span>: <span style=color:#e6db74>&#34;{{ container.hostname }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ostemplate</span>: <span style=color:#e6db74>&#34;{{ container.ostemplate }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>storage</span>: <span style=color:#e6db74>&#34;{{ container.storage }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>cores</span>: <span style=color:#e6db74>&#34;{{ container.cores }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>memory</span>: <span style=color:#e6db74>&#34;{{ container.memory }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>swap</span>: <span style=color:#e6db74>&#34;{{ container.swap }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>disk</span>: <span style=color:#e6db74>&#34;{{ container.disk }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>netif</span>: <span style=color:#e6db74>&#39;{&#34;net0&#34;: &#34;{{ container.net }}&#34;}&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>password</span>: <span style=color:#e6db74>&#34;{{ container.password }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
</span></span></code></pre></div><p>This file serves as the basic scaffold for creating a new LXC container. Roles are designed to be agnostic of the overall play structure—they assume that the necessary variables will be passed in through the playbook or defaults.</p><p>Next, update the role’s main task file so it knows when to run the creation task. Edit <code>roles/proxmox_lxc/tasks/main.yml</code> to include:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Run creation tasks if state is present</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>include_tasks</span>: <span style=color:#ae81ff>create.yml</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>when</span>: <span style=color:#ae81ff>container.state == &#39;present&#39;</span>
</span></span></code></pre></div><p>This means that when the <code>state</code> of the container is set to <code>present</code>, the role will execute the tasks defined in <code>create.yml</code> to create the LXC.</p><h3 id=default-variables>Default Variables<a href=#default-variables class=hanchor arialabel=Anchor>#</a></h3><p>Under <code>roles/proxmox_lxc/defaults/main.yml</code>, add default variables for your Proxmox server hostname and node name. These defaults can be overridden in your playbook if needed:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># Default Proxmox settings</span>
</span></span><span style=display:flex><span><span style=color:#f92672>proxmox_api_host</span>: <span style=color:#e6db74>&#34;proxmox.example.com&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>proxmox_node</span>: <span style=color:#e6db74>&#34;pve&#34;</span>
</span></span></code></pre></div><h3 id=create-a-playbook>Create a Playbook<a href=#create-a-playbook class=hanchor arialabel=Anchor>#</a></h3><p>Create a directory called <code>playbooks</code> (if it doesn’t already exist) and then create a new file inside it called <code>manage-lxcs.yml</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir playbooks <span style=color:#f92672>&amp;&amp;</span> touch playbooks/manage-lxcs.yml
</span></span></code></pre></div><p>Edit <code>playbooks/manage-lxcs.yml</code> and add the following content:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Manage Proxmox LXC containers</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>localhost</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>connection</span>: <span style=color:#ae81ff>local</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gather_facts</span>: <span style=color:#66d9ef>no</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>vars_files</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>../vars/proxmox-vault.yml</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Define a list of containers</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>vars</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>lxcs</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>vmid</span>: <span style=color:#ae81ff>110</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>hostname</span>: <span style=color:#ae81ff>test01</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Your OS template for the LXC</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>ostemplate</span>: <span style=color:#e6db74>&#34;local:vztmpl/debian-12-standard_12.7-1_amd64.tar.zst&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>storage</span>: <span style=color:#e6db74>&#34;local-lvm&#34;</span> <span style=color:#75715e># Storage volume</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>cores</span>: <span style=color:#ae81ff>1</span>             <span style=color:#75715e># Number of vCPU cores</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>memory</span>: <span style=color:#ae81ff>1024</span>         <span style=color:#75715e># Memory in MB</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>swap</span>: <span style=color:#ae81ff>512</span>            <span style=color:#75715e># Swap in MB</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>disk</span>: <span style=color:#e6db74>&#34;local-lvm:25&#34;</span> <span style=color:#75715e># Storage volume name and size in GB</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>net</span>: <span style=color:#e6db74>&#34;name=eth0,bridge=vmbr0,ip=dhcp&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>password</span>: <span style=color:#e6db74>&#34;containerpassword&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Process each LXC container</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>include_role</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>proxmox_lxc</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>loop</span>: <span style=color:#e6db74>&#34;{{ lxcs }}&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>loop_control</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>loop_var</span>: <span style=color:#ae81ff>container</span>
</span></span></code></pre></div><p>In this playbook:</p><ul><li>Your API credentials are loaded from the vault file.</li><li>A list of container definitions is provided under the <code>lxcs</code> variable.</li><li>The playbook loops over each container definition and applies the <code>proxmox_lxc</code> role to each one, passing the container details via the variable <code>container</code>.</li></ul><p>Now run your playbook with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible-playbook --vault-password-file vars/.proxmox-vault-pass playbooks/manage-lxcs.yml
</span></span></code></pre></div><p>If everything was configured correctly up to this point, you should see output similar to:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>Manage Proxmox LXC containers<span style=color:#f92672>]</span> *****************************************************************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Process each LXC container<span style=color:#f92672>]</span> ********************************************************************************************************************************************************
</span></span><span style=display:flex><span>included: proxmox_lxc <span style=color:#66d9ef>for</span> localhost <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>(</span>item<span style=color:#f92672>={</span><span style=color:#e6db74>&#39;vmid&#39;</span>: 110, <span style=color:#e6db74>&#39;hostname&#39;</span>: <span style=color:#e6db74>&#39;test01&#39;</span>, <span style=color:#e6db74>&#39;ostemplate&#39;</span>: <span style=color:#e6db74>&#39;local:vztmpl/debian-12-standard_12.7-1_amd64.tar.zst&#39;</span>, <span style=color:#e6db74>&#39;storage&#39;</span>: <span style=color:#e6db74>&#39;local-lvm&#39;</span>, <span style=color:#e6db74>&#39;cores&#39;</span>: 1, <span style=color:#e6db74>&#39;memory&#39;</span>: 1024, <span style=color:#e6db74>&#39;swap&#39;</span>: 512, <span style=color:#e6db74>&#39;disk&#39;</span>: <span style=color:#e6db74>&#39;local-lvm:25&#39;</span>, <span style=color:#e6db74>&#39;net&#39;</span>: <span style=color:#e6db74>&#39;name=eth0,bridge=vmbr0,ip=dhcp&#39;</span>, <span style=color:#e6db74>&#39;password&#39;</span>: <span style=color:#e6db74>&#39;containerpassword&#39;</span>, <span style=color:#e6db74>&#39;state&#39;</span>: <span style=color:#e6db74>&#39;present&#39;</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>proxmox_lxc : Run creation tasks <span style=color:#66d9ef>if</span> state is present<span style=color:#f92672>]</span> ******************************************************************************************************************************
</span></span><span style=display:flex><span>included: /home/demo/ansible/roles/proxmox_lxc/tasks/create.yml <span style=color:#66d9ef>for</span> localhost
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>proxmox_lxc : Create LXC container on Proxmox<span style=color:#f92672>]</span> *************************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>localhost<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *******************************************************************************************************************************************************************************
</span></span><span style=display:flex><span>localhost                  : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span></code></pre></div><p>Check your Proxmox interface to confirm the container has been created:</p><p><img src=../../img/proxmox-ansible-create-1.jpg alt="Screenshot of instance dashboard"></p><h3 id=adding-a-delete-task>Adding a Delete Task<a href=#adding-a-delete-task class=hanchor arialabel=Anchor>#</a></h3><p>To allow our playbook to both create and delete LXCs based on the defined state, we need to add a delete task to our role. First, create another new file in <code>roles/proxmox_lxc/tasks/</code> called <code>delete.yml</code> and add the following content:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#75715e># roles/proxmox_lxc/tasks/delete.yml</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Delete LXC container on Proxmox</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>community.general.proxmox</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>api_host</span>: <span style=color:#e6db74>&#34;{{ proxmox_api_host }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>api_user</span>: <span style=color:#e6db74>&#34;{{ proxmox_api_user }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>api_token_id</span>: <span style=color:#e6db74>&#34;{{ proxmox_api_id }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>api_token_secret</span>: <span style=color:#e6db74>&#34;{{ proxmox_api_secret }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>node</span>: <span style=color:#e6db74>&#34;{{ proxmox_node }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>vmid</span>: <span style=color:#e6db74>&#34;{{ container.vmid }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>state</span>: <span style=color:#ae81ff>absent</span>
</span></span></code></pre></div><p>Next, update your role&rsquo;s main tasks file to include the deletion tasks when the container state is set to &lsquo;<code>absent</code>&rsquo;. Edit <code>roles/proxmox_lxc/tasks/main.yml</code> and add the following line:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Run deletion tasks if state is absent</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>include_tasks</span>: <span style=color:#ae81ff>delete.yml</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>when</span>: <span style=color:#ae81ff>container.state == &#39;absent&#39;</span>
</span></span></code></pre></div><p>Now let&rsquo;s modify our playbook (<code>playbooks/manage-lxcs.yml</code>) to test both creation and deletion. Update it so that it defines a list of containers with varying states:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>  <span style=color:#75715e># Define a list of containers</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>vars</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>lxcs</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>vmid</span>: <span style=color:#ae81ff>110</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>hostname</span>: <span style=color:#ae81ff>test01</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Your OS template for the LXC</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>ostemplate</span>: <span style=color:#e6db74>&#34;local:vztmpl/debian-12-standard_12.7-1_amd64.tar.zst&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>storage</span>: <span style=color:#e6db74>&#34;local-lvm&#34;</span> <span style=color:#75715e># Storage volume</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>cores</span>: <span style=color:#ae81ff>1</span>             <span style=color:#75715e># Number of vCPU cores</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>memory</span>: <span style=color:#ae81ff>1024</span>         <span style=color:#75715e># Memory in MB</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>swap</span>: <span style=color:#ae81ff>512</span>            <span style=color:#75715e># Swap in MB</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>disk</span>: <span style=color:#e6db74>&#34;local-lvm:25&#34;</span> <span style=color:#75715e># Storage volume name and size in GB</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>net</span>: <span style=color:#e6db74>&#34;name=eth0,bridge=vmbr0,ip=dhcp&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>password</span>: <span style=color:#e6db74>&#34;containerpassword&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>absent</span> <span style=color:#75715e># Remove the container</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>vmid</span>: <span style=color:#ae81ff>111</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>hostname</span>: <span style=color:#ae81ff>test02</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>ostemplate</span>: <span style=color:#e6db74>&#34;local:vztmpl/debian-12-standard_12.7-1_amd64.tar.zst&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>storage</span>: <span style=color:#e6db74>&#34;local-lvm&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>cores</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>memory</span>: <span style=color:#ae81ff>1024</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>swap</span>: <span style=color:#ae81ff>512</span>      
</span></span><span style=display:flex><span>        <span style=color:#f92672>disk</span>: <span style=color:#e6db74>&#34;local-lvm:25&#34;</span> 
</span></span><span style=display:flex><span>        <span style=color:#f92672>net</span>: <span style=color:#e6db74>&#34;name=eth0,bridge=vmbr0,ip=dhcp&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>password</span>: <span style=color:#e6db74>&#34;containerpassword&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
</span></span></code></pre></div><p>When you run this playbook, Ansible will loop through your container definitions. It will delete the container where <code>state</code> is set to <code>absent</code> (in this case, <code>test01</code>) and create a container where <code>state</code> is set to <code>present</code> (here, <code>test02</code>).</p><p>Here&rsquo;s an example of the expected output:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>Manage Proxmox LXC containers<span style=color:#f92672>]</span> *****************************************************************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Process each LXC container<span style=color:#f92672>]</span> ********************************************************************************************************************************************************
</span></span><span style=display:flex><span>included: proxmox_lxc <span style=color:#66d9ef>for</span> localhost <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>(</span>item<span style=color:#f92672>={</span><span style=color:#e6db74>&#39;vmid&#39;</span>: 110, <span style=color:#e6db74>&#39;hostname&#39;</span>: <span style=color:#e6db74>&#39;test01&#39;</span>, <span style=color:#e6db74>&#39;ostemplate&#39;</span>: <span style=color:#e6db74>&#39;local:vztmpl/debian-12-standard_12.7-1_amd64.tar.zst&#39;</span>, <span style=color:#e6db74>&#39;storage&#39;</span>: <span style=color:#e6db74>&#39;local-lvm&#39;</span>, <span style=color:#e6db74>&#39;cores&#39;</span>: 1, <span style=color:#e6db74>&#39;memory&#39;</span>: 1024, <span style=color:#e6db74>&#39;swap&#39;</span>: 512, <span style=color:#e6db74>&#39;disk&#39;</span>: <span style=color:#e6db74>&#39;local-lvm:25&#39;</span>, <span style=color:#e6db74>&#39;net&#39;</span>: <span style=color:#e6db74>&#39;name=eth0,bridge=vmbr0,ip=dhcp&#39;</span>, <span style=color:#e6db74>&#39;password&#39;</span>: <span style=color:#e6db74>&#39;containerpassword&#39;</span>, <span style=color:#e6db74>&#39;state&#39;</span>: <span style=color:#e6db74>&#39;absent&#39;</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>included: proxmox_lxc <span style=color:#66d9ef>for</span> localhost <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>(</span>item<span style=color:#f92672>={</span><span style=color:#e6db74>&#39;vmid&#39;</span>: 111, <span style=color:#e6db74>&#39;hostname&#39;</span>: <span style=color:#e6db74>&#39;test02&#39;</span>, <span style=color:#e6db74>&#39;ostemplate&#39;</span>: <span style=color:#e6db74>&#39;local:vztmpl/debian-12-standard_12.7-1_amd64.tar.zst&#39;</span>, <span style=color:#e6db74>&#39;storage&#39;</span>: <span style=color:#e6db74>&#39;local-lvm&#39;</span>, <span style=color:#e6db74>&#39;cores&#39;</span>: 1, <span style=color:#e6db74>&#39;memory&#39;</span>: 1024, <span style=color:#e6db74>&#39;swap&#39;</span>: 512, <span style=color:#e6db74>&#39;disk&#39;</span>: <span style=color:#e6db74>&#39;local-lvm:25&#39;</span>, <span style=color:#e6db74>&#39;net&#39;</span>: <span style=color:#e6db74>&#39;name=eth0,bridge=vmbr0,ip=dhcp&#39;</span>, <span style=color:#e6db74>&#39;password&#39;</span>: <span style=color:#e6db74>&#39;containerpassword&#39;</span>, <span style=color:#e6db74>&#39;state&#39;</span>: <span style=color:#e6db74>&#39;present&#39;</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>proxmox_lxc : Run creation tasks <span style=color:#66d9ef>if</span> state is present<span style=color:#f92672>]</span> ******************************************************************************************************************************
</span></span><span style=display:flex><span>skipping: <span style=color:#f92672>[</span>localhost<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>proxmox_lxc : Run deletion tasks <span style=color:#66d9ef>if</span> state is absent<span style=color:#f92672>]</span> *******************************************************************************************************************************
</span></span><span style=display:flex><span>included: /home/demo/ansible/roles/proxmox_lxc/tasks/delete.yml <span style=color:#66d9ef>for</span> localhost
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>proxmox_lxc : Delete LXC container on Proxmox<span style=color:#f92672>]</span> *************************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>localhost<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>proxmox_lxc : Run creation tasks <span style=color:#66d9ef>if</span> state is present<span style=color:#f92672>]</span> ******************************************************************************************************************************
</span></span><span style=display:flex><span>included: /home/demo/ansible/roles/proxmox_lxc/tasks/create.yml <span style=color:#66d9ef>for</span> localhost
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>proxmox_lxc : Create LXC container on Proxmox<span style=color:#f92672>]</span> *************************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>localhost<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>proxmox_lxc : Run deletion tasks <span style=color:#66d9ef>if</span> state is absent<span style=color:#f92672>]</span> *******************************************************************************************************************************
</span></span><span style=display:flex><span>skipping: <span style=color:#f92672>[</span>localhost<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *******************************************************************************************************************************************************************************
</span></span><span style=display:flex><span>localhost                  : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>6</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span></code></pre></div><h3 id=abstracting-the-lxc-data>Abstracting the LXC Data<a href=#abstracting-the-lxc-data class=hanchor arialabel=Anchor>#</a></h3><p>Instead of hardcoding our list of LXCs directly in the playbook, it&rsquo;s a good idea to store that data in a separate file. This way, you can make changes without editing your playbooks directly. Create a file called <code>lxcs.yml</code> in the <code>vars/</code> directory and add the following content:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># List of managed LXC containers</span>
</span></span><span style=display:flex><span><span style=color:#f92672>lxcs</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>vmid</span>: <span style=color:#ae81ff>110</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>hostname</span>: <span style=color:#ae81ff>test01</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Your OS template for the LXC</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ostemplate</span>: <span style=color:#e6db74>&#34;local:vztmpl/debian-12-standard_12.7-1_amd64.tar.zst&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>storage</span>: <span style=color:#e6db74>&#34;local-lvm&#34;</span> <span style=color:#75715e># Storage volume</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>cores</span>: <span style=color:#ae81ff>1</span>             <span style=color:#75715e># Number of vCPU cores</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>memory</span>: <span style=color:#ae81ff>1024</span>         <span style=color:#75715e># Memory in MB</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>swap</span>: <span style=color:#ae81ff>512</span>            <span style=color:#75715e># Swap in MB</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>disk</span>: <span style=color:#e6db74>&#34;local-lvm:25&#34;</span> <span style=color:#75715e># Storage volume name and size in GB</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>net</span>: <span style=color:#e6db74>&#34;name=eth0,bridge=vmbr0,ip=dhcp&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>password</span>: <span style=color:#e6db74>&#34;containerpassword&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>state</span>: <span style=color:#ae81ff>absent</span> <span style=color:#75715e># Remove the container</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>vmid</span>: <span style=color:#ae81ff>111</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>hostname</span>: <span style=color:#ae81ff>test02</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ostemplate</span>: <span style=color:#e6db74>&#34;local:vztmpl/debian-12-standard_12.7-1_amd64.tar.zst&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>storage</span>: <span style=color:#e6db74>&#34;local-lvm&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>cores</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>memory</span>: <span style=color:#ae81ff>1024</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>swap</span>: <span style=color:#ae81ff>512</span>      
</span></span><span style=display:flex><span>    <span style=color:#f92672>disk</span>: <span style=color:#e6db74>&#34;local-lvm:25&#34;</span> 
</span></span><span style=display:flex><span>    <span style=color:#f92672>net</span>: <span style=color:#e6db74>&#34;name=eth0,bridge=vmbr0,ip=dhcp&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>password</span>: <span style=color:#e6db74>&#34;containerpassword&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>state</span>: <span style=color:#ae81ff>absent</span>
</span></span></code></pre></div><p><em>Note:</em> I set the state of the second test container to <code>absent</code> because I intend to destroy it.</p><p>Now, update your playbook so it loads both the vault and the LXC definitions. The playbook should look like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Manage Proxmox LXC containers</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>localhost</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>connection</span>: <span style=color:#ae81ff>local</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gather_facts</span>: <span style=color:#66d9ef>no</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Load credentials and LXC definitions</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>vars_files</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>../vars/proxmox-vault.yml</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>../vars/lxcs.yaml</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Process each LXC container</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>include_role</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>proxmox_lxc</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>loop</span>: <span style=color:#e6db74>&#34;{{ lxcs }}&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>loop_control</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>loop_var</span>: <span style=color:#ae81ff>container</span>
</span></span></code></pre></div><p>Run your playbook again to test it out.</p><h2 id=closing>Closing<a href=#closing class=hanchor arialabel=Anchor>#</a></h2><p>That concludes part one of my foray into Proxmox Ansible automation. In part two, I&rsquo;ll fine-tune the playbook and tasks further, and also automate the setup, configuration, and software installations on some VMs.</p><h2 id=github>GitHub<a href=#github class=hanchor arialabel=Anchor>#</a></h2><p>Download these files <a href=https://github.com/sbarbett/proxmox-ansible>on my GitHub</a>. More updates to come.</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><a href=https://sbarbett.github.io/reticulating-splines/posts/ansible-playbooks-for-proxmox-lxcs-pt2/ class="button inline prev">&lt; [<span class=button__text>Ansible Playbooks for Proxmox and LXCs Part 2</span>]
</a>::
<a href=https://sbarbett.github.io/reticulating-splines/posts/terraform-oci-pihole/ class="button inline next">[<span class=button__text>Deploying an OCI Pi-hole with Terraform</span>] ></a></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2025 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/reticulating-splines/bundle.min.js></script></div></body></html>
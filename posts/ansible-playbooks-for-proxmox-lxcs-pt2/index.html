<!doctype html><html lang=en><head><title>Ansible Playbooks for Proxmox and LXCs Part 2 :: reticulating splines</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Part 2 digs into the real-world challenges of managing Proxmox container states—waiting for containers to finally be ready, handling states like 'started' and 'stopped', and upgrading our modules so SSH key injection works. A practical look at the trials (and occasional headaches) of automating Proxmox with Ansible."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://sbarbett.github.io/reticulating-splines/posts/ansible-playbooks-for-proxmox-lxcs-pt2/><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/buttons.min.3be0bba9fe18b5b77c8fe97175a5ff803eb3b8d6b94a4c43e6c842bc229040f1.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/code.min.628b83582b7e3ce5fbec137a2c22e9dd728066c2a25433bc713f3c02f60e9d0d.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/fonts.min.90c955c31dd7c0e05aae3d4f583d4d8a2af799d69c961337eaf2a825063a55dd.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/footer.min.2e3eb191baee58dd05a9f0104ac1fab0827bca7c64dafe0b2579f934c33a1d69.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/header.min.b6fb4423cf82a9f9d7abc9cd010223fa3d70a6526a3f28f8e17d814c06e18f9e.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/main.min.ddc450348e2172fcf09bb193f216484ec68c51f52c43c89268b93314cb7805ae.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/menu.min.036f7f3c01b34c968c3c11f671600515ea8247bdb345694d1c244c92edc67a24.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/pagination.min.82f6400eae7c7c6dc3c866733c2ec0579e4089608fea69400ff85b3880aa0d3c.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/post.min.f22509cc505be9b59106980693175422c998445b17d3b4bb9c154dac90186ae9.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/prism.min.9023bbc24533d09e97a51a0a42a5a7bfe4c591ae167c5551fb1d2191d11977c0.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/syntax.min.28d2d93e80d9fc88428d8438285537c167ec74544ef064da1cc0313254904b54.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/terminal.min.f00ec1a3d030ac6d3aed932564fc961b9980150830dc8ef37f964f2858ccf558.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/style.css><link rel="shortcut icon" href=https://sbarbett.github.io/reticulating-splines/favicon.png><link rel=apple-touch-icon href=https://sbarbett.github.io/reticulating-splines/apple-touch-icon.png><meta name=twitter:card content="summary"><meta name=twitter:site content="https://shane.barbetta.me"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Ansible Playbooks for Proxmox and LXCs Part 2"><meta property="og:description" content="Part 2 digs into the real-world challenges of managing Proxmox container states—waiting for containers to finally be ready, handling states like 'started' and 'stopped', and upgrading our modules so SSH key injection works. A practical look at the trials (and occasional headaches) of automating Proxmox with Ansible."><meta property="og:url" content="https://sbarbett.github.io/reticulating-splines/posts/ansible-playbooks-for-proxmox-lxcs-pt2/"><meta property="og:site_name" content="reticulating splines"><meta property="og:image" content="https://sbarbett.github.io/reticulating-splines/og-image.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2025-02-12 00:00:00 +0000 UTC"></head><body><div class="container full"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>reticulating splines</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=https://shane.barbetta.me>about</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=https://shane.barbetta.me>about</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://sbarbett.github.io/reticulating-splines/posts/ansible-playbooks-for-proxmox-lxcs-pt2/>Ansible Playbooks for Proxmox and LXCs Part 2</a></h1><div class=post-meta><time class=post-date>2025-02-12</time></div><span class=post-tags>#<a href=https://sbarbett.github.io/reticulating-splines/tags/proxmox/>proxmox</a>&nbsp;
#<a href=https://sbarbett.github.io/reticulating-splines/tags/ansible/>ansible</a>&nbsp;</span><div class=post-content><div><h1 id=ansible-playbooks-for-proxmox-and-lxcs---part-2>Ansible Playbooks for Proxmox and LXCs - Part 2<a href=#ansible-playbooks-for-proxmox-and-lxcs---part-2 class=hanchor arialabel=Anchor>#</a></h1><p>I want to continue building on the state-driven modularity of tasks in this Proxmox role. In addition to <code>present</code> (the default state) and <code>absent</code>, Proxmox supports the following states:</p><ul><li><code>started</code></li><li><code>stopped</code></li><li><code>restarted</code></li><li><code>template</code></li></ul><p>By having the state variable drive the behavior, we implicitly declare the desired outcome. This aligns with Ansible&rsquo;s idempotent design—where the playbook converges the system to the desired state instead of running a series of imperative commands.</p><p>Plus, it adds scalability: down the road, if we decide to manage even more nuanced aspects of the container lifecycle, we can handle each state independently and avoid the rigamarole of overlapping logic.</p><h2 id=adding-stoppedstarted-states>Adding Stopped/Started States<a href=#adding-stoppedstarted-states class=hanchor arialabel=Anchor>#</a></h2><p>To recap my goals:</p><ol><li>Spin up a container</li><li>Automatically configure the container settings</li><li>Install some software</li><li>Handle all of the above in a single playbook</li></ol><p>I need the container to automatically start itself once it is created. So, I added the <code>started</code> and stopped <code>states</code> to my tasks.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#75715e># roles/proxmox_lxc/tasks/start.yml</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Ensure LXC container is started on Proxmox</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>community.general.proxmox</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>api_host</span>: <span style=color:#e6db74>&#34;{{ proxmox_api_host }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>api_user</span>: <span style=color:#e6db74>&#34;{{ proxmox_api_user }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>api_token_id</span>: <span style=color:#e6db74>&#34;{{ proxmox_api_id }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>api_token_secret</span>: <span style=color:#e6db74>&#34;{{ proxmox_api_secret }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>node</span>: <span style=color:#e6db74>&#34;{{ proxmox_node }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>vmid</span>: <span style=color:#e6db74>&#34;{{ container.vmid }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>state</span>: <span style=color:#ae81ff>started</span>
</span></span></code></pre></div><p><em>Note:</em> <code>stop.yml</code> looks exactly the same, just with the word &ldquo;stop&rdquo; instead of &ldquo;start.&rdquo;</p><p>In my <code>main.yml</code> file, I added the following.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Run start tasks if state is started</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>include_tasks</span>: <span style=color:#ae81ff>start.yml</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>when</span>: <span style=color:#ae81ff>container.state == &#39;started&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Run stop tasks if state is stopped</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>include_tasks</span>: <span style=color:#ae81ff>stop.yml</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>when</span>: <span style=color:#ae81ff>container.state == &#39;stopped&#39;</span>
</span></span></code></pre></div><p>A couple of things to note: Proxmox won&rsquo;t let you delete (<code>absent</code>) a container unless you stop it first. Likewise, the Proxmox module doesn&rsquo;t let you skip the <code>present</code> state and go directly to <code>started</code>. In other words, you can&rsquo;t define all your container settings, set the state to <code>started</code>, and expect it to just work. You have to create the container first using <code>present</code>, wait for it to be fully registered, and then start it.</p><p>The need to <em>wait</em> arises due to race conditions—the container doesn&rsquo;t create itself fast enough. If you try to start it too early, you&rsquo;ll get an error message like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>TASK <span style=color:#f92672>[</span>proxmox_lxc : Ensure LXC container is started on Proxmox<span style=color:#f92672>]</span> **************************************************************************************************************************
</span></span><span style=display:flex><span>fatal: <span style=color:#f92672>[</span>localhost<span style=color:#f92672>]</span>: FAILED! <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;changed&#34;</span>: false, <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;An error occurred: &#39;name&#39;&#34;</span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>You could simply insert a pause, but that feels hacky. I would much rather <em>fluently</em> wait until the container&rsquo;s state is suitable for starting. Since Ansible is built on top of the <code>proxmoxer</code> Python library—and we already have all our authentication parameters set up—why not leverage that in a script?</p><p>I saved the following Python script to <code>roles/proxmox_lxc/files/wait_for_container.py</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env python3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> argparse
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> proxmoxer <span style=color:#f92672>import</span> ProxmoxAPI
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>parser <span style=color:#f92672>=</span> argparse<span style=color:#f92672>.</span>ArgumentParser(
</span></span><span style=display:flex><span>    description<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Wait for a Proxmox LXC container to be registered and have the expected hostname.&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>parser<span style=color:#f92672>.</span>add_argument(<span style=color:#e6db74>&#34;--host&#34;</span>, required<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, help<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Proxmox API host&#34;</span>)
</span></span><span style=display:flex><span>parser<span style=color:#f92672>.</span>add_argument(<span style=color:#e6db74>&#34;--user&#34;</span>, required<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, help<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Proxmox API user&#34;</span>)
</span></span><span style=display:flex><span>parser<span style=color:#f92672>.</span>add_argument(<span style=color:#e6db74>&#34;--token_name&#34;</span>, required<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, help<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Proxmox API token name&#34;</span>)
</span></span><span style=display:flex><span>parser<span style=color:#f92672>.</span>add_argument(<span style=color:#e6db74>&#34;--token_value&#34;</span>, required<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, help<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Proxmox API token secret&#34;</span>)
</span></span><span style=display:flex><span>parser<span style=color:#f92672>.</span>add_argument(<span style=color:#e6db74>&#34;--node&#34;</span>, required<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, help<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Proxmox node name&#34;</span>)
</span></span><span style=display:flex><span>parser<span style=color:#f92672>.</span>add_argument(<span style=color:#e6db74>&#34;--vmid&#34;</span>, type<span style=color:#f92672>=</span>int, required<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, help<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;VMID of the container&#34;</span>)
</span></span><span style=display:flex><span>parser<span style=color:#f92672>.</span>add_argument(<span style=color:#e6db74>&#34;--expected-hostname&#34;</span>, required<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, help<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Expected hostname for the container&#34;</span>)
</span></span><span style=display:flex><span>parser<span style=color:#f92672>.</span>add_argument(<span style=color:#e6db74>&#34;--retries&#34;</span>, type<span style=color:#f92672>=</span>int, default<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>, help<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Number of retries&#34;</span>)
</span></span><span style=display:flex><span>parser<span style=color:#f92672>.</span>add_argument(<span style=color:#e6db74>&#34;--delay&#34;</span>, type<span style=color:#f92672>=</span>int, default<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>, help<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Delay between retries in seconds&#34;</span>)
</span></span><span style=display:flex><span>args <span style=color:#f92672>=</span> parser<span style=color:#f92672>.</span>parse_args()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>proxmox <span style=color:#f92672>=</span> ProxmoxAPI(
</span></span><span style=display:flex><span>    args<span style=color:#f92672>.</span>host,
</span></span><span style=display:flex><span>    user<span style=color:#f92672>=</span>args<span style=color:#f92672>.</span>user,
</span></span><span style=display:flex><span>    token_name<span style=color:#f92672>=</span>args<span style=color:#f92672>.</span>token_name,
</span></span><span style=display:flex><span>    token_value<span style=color:#f92672>=</span>args<span style=color:#f92672>.</span>token_value,
</span></span><span style=display:flex><span>    verify_ssl<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>,
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> attempt <span style=color:#f92672>in</span> range(args<span style=color:#f92672>.</span>retries):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        <span style=color:#75715e># Get the container configuration</span>
</span></span><span style=display:flex><span>        config <span style=color:#f92672>=</span> proxmox<span style=color:#f92672>.</span>nodes(args<span style=color:#f92672>.</span>node)<span style=color:#f92672>.</span>lxc(args<span style=color:#f92672>.</span>vmid)<span style=color:#f92672>.</span>config<span style=color:#f92672>.</span>get()
</span></span><span style=display:flex><span>        current_hostname <span style=color:#f92672>=</span> config<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;hostname&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> current_hostname <span style=color:#f92672>==</span> args<span style=color:#f92672>.</span>expected_hostname:
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Container </span><span style=color:#e6db74>{</span>args<span style=color:#f92672>.</span>vmid<span style=color:#e6db74>}</span><span style=color:#e6db74> exists with expected hostname: </span><span style=color:#e6db74>{</span>current_hostname<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>            sys<span style=color:#f92672>.</span>exit(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            sys<span style=color:#f92672>.</span>stderr<span style=color:#f92672>.</span>write(
</span></span><span style=display:flex><span>                <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Attempt </span><span style=color:#e6db74>{</span>attempt<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span><span style=color:#e6db74>}</span><span style=color:#e6db74>: Container exists but hostname &#39;</span><span style=color:#e6db74>{</span>current_hostname<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39; does not match expected &#39;</span><span style=color:#e6db74>{</span>args<span style=color:#f92672>.</span>expected_hostname<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;. Retrying in </span><span style=color:#e6db74>{</span>args<span style=color:#f92672>.</span>delay<span style=color:#e6db74>}</span><span style=color:#e6db74> seconds...</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        sys<span style=color:#f92672>.</span>stderr<span style=color:#f92672>.</span>write(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Attempt </span><span style=color:#e6db74>{</span>attempt<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span><span style=color:#e6db74>}</span><span style=color:#e6db74>: Container not found. Retrying in </span><span style=color:#e6db74>{</span>args<span style=color:#f92672>.</span>delay<span style=color:#e6db74>}</span><span style=color:#e6db74> seconds...</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    time<span style=color:#f92672>.</span>sleep(args<span style=color:#f92672>.</span>delay)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sys<span style=color:#f92672>.</span>exit(<span style=color:#ae81ff>1</span>)
</span></span></code></pre></div><p>Make it executable:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>chmod +x roles/proxmox_lxc/files/wait_for_container.py
</span></span></code></pre></div><p>Now, I created a new task that invokes this script, under <code>roles/proxmox_lxc/files/status.yml</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Wait for container to be registered with expected hostname</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>command</span>: &gt;<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    {{ role_path }}/files/wait_for_container.py
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    --host &#34;{{ proxmox_api_host }}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    --user &#34;{{ proxmox_api_user }}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    --token_name &#34;{{ proxmox_api_id }}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    --token_value &#34;{{ proxmox_api_secret }}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    --node &#34;{{ proxmox_node }}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    --vmid &#34;{{ container.vmid }}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    --expected-hostname &#34;{{ container.hostname }}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    --retries 10
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    --delay 3</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>register</span>: <span style=color:#ae81ff>container_status</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>until</span>: <span style=color:#ae81ff>container_status.rc == 0</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>retries</span>: <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>delay</span>: <span style=color:#ae81ff>3</span>
</span></span></code></pre></div><p>Let me explain:</p><ol><li>The Python script loads the <code>proxmoxer</code> module and authenticates against our Proxmox instance&rsquo;s API.</li><li>It then retrieves the configuration for the VMID of the LXC we just created.</li><li>It checks to ensure that the container&rsquo;s hostname matches the hostname defined in our LXC manifest.</li><li>The script exits with a return code of <code>0</code> (success) if the hostname matches, or <code>1</code> (failure) if not.</li><li>Our Ansible task runs this script, waiting (with a 3-second delay) until it sees a return code of <code>0</code>, retrying up to 10 times.</li></ol><p>Once these conditions are met, the container is fully spun up and ready to be started.</p><h2 id=upgrade-the-communitygeneral-module-and-uploading-a-public-key>Upgrade the <code>community.general</code> Module and Uploading a Public Key<a href=#upgrade-the-communitygeneral-module-and-uploading-a-public-key class=hanchor arialabel=Anchor>#</a></h2><p>It is essential that we be able to <code>ssh</code> into our instance once it is configured by Ansible. By default, Debian does not allow root login using a password—you&rsquo;d have to log in to your LXC via Proxmox (<code>pct enter</code>) and explicitly enable it. And that is:</p><ol><li>Not in the spirit of full automation</li><li>Shit security</li></ol><p>Instead, we should include a public key using the <code>pubkey</code> parameter. In <code>create.yml</code>, I added the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>pubkey</span>: <span style=color:#e6db74>&#34;{{ lookup(&#39;file&#39;, container.pubkey_file) | default(omit) }}&#34;</span>
</span></span></code></pre></div><p>In your <code>lxcs.yml</code> file, add the path to your private key:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>pubkey_file</span>: <span style=color:#e6db74>&#34;~/.ssh/nuc_rsa.pub&#34;</span>
</span></span></code></pre></div><p>It was at this moment that I ran my playbook and encountered a very confusing error that took me a couple of hours to figure out:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>   <span style=color:#f92672>&#34;changed&#34;</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>   <span style=color:#f92672>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;An error occurred: 400 Bad Request: Parameter verification failed. - {&#39;ssh-public-key&#39;: &#39;property is not defined in schema and the schema does not allow additional properties&#39;}&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>What do you <em>mean</em> the property is not in the schema? It is clearly defined in the <a href=https://docs.ansible.com/ansible/latest/collections/community/general/proxmox_module.html#parameter-pubkey>Ansible document</a>!</p><p>Well, it turns out that the version of the <code>community.general</code> module that came <em>pre-installed</em> with the most recent version of Ansible was not up-to-date. I fixed this by re-running the collection installation with the <code>--upgrade</code> flag:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible-galaxy collection install community.general --upgrade
</span></span></code></pre></div><p>In retrospect, this probably should have been done at the very start. I <em>did</em> run <code>ansible-galaxy collection install community.general</code>, but it <em>didn&rsquo;t tell me there was a new version available</em>. I accept responsibility for that oversight, though a clearer message would have been nice.</p><h2 id=storing-the-container-ip>Storing the Container IP<a href=#storing-the-container-ip class=hanchor arialabel=Anchor>#</a></h2><p>In practice, we could just give our container a static IP, but, in short, I don&rsquo;t want to. I create my containers using DHCP and let the router give them an address automatically. Afterwards, I&rsquo;ll put a reservation in my router and modify the container to be static (we can automate this too, but not for transient test VMs—later).</p><p>That said, we need to make another <code>proxmoxer</code> script to get the interface info from the newly created LXC. Create an executable file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>touch roles/proxmox_lxc/files/get_container_ip.py
</span></span><span style=display:flex><span>chmod +x roles/proxmox_lxc/files/get_container_ip.py
</span></span></code></pre></div><p>Edit that file and add the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env python3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> argparse
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> proxmoxer <span style=color:#f92672>import</span> ProxmoxAPI
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>parser <span style=color:#f92672>=</span> argparse<span style=color:#f92672>.</span>ArgumentParser(
</span></span><span style=display:flex><span>    description<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Retrieve container IP from Proxmox with retries&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>parser<span style=color:#f92672>.</span>add_argument(<span style=color:#e6db74>&#34;--host&#34;</span>, required<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, help<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Proxmox API host&#34;</span>)
</span></span><span style=display:flex><span>parser<span style=color:#f92672>.</span>add_argument(<span style=color:#e6db74>&#34;--user&#34;</span>, required<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, help<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Proxmox API user&#34;</span>)
</span></span><span style=display:flex><span>parser<span style=color:#f92672>.</span>add_argument(<span style=color:#e6db74>&#34;--token_name&#34;</span>, required<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, help<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Proxmox API token name&#34;</span>)
</span></span><span style=display:flex><span>parser<span style=color:#f92672>.</span>add_argument(<span style=color:#e6db74>&#34;--token_value&#34;</span>, required<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, help<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Proxmox API token secret&#34;</span>)
</span></span><span style=display:flex><span>parser<span style=color:#f92672>.</span>add_argument(<span style=color:#e6db74>&#34;--node&#34;</span>, required<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, help<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Proxmox node name&#34;</span>)
</span></span><span style=display:flex><span>parser<span style=color:#f92672>.</span>add_argument(<span style=color:#e6db74>&#34;--vmid&#34;</span>, type<span style=color:#f92672>=</span>int, required<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, help<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;VMID of the container&#34;</span>)
</span></span><span style=display:flex><span>parser<span style=color:#f92672>.</span>add_argument(<span style=color:#e6db74>&#34;--retries&#34;</span>, type<span style=color:#f92672>=</span>int, default<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>, help<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Number of retries&#34;</span>)
</span></span><span style=display:flex><span>parser<span style=color:#f92672>.</span>add_argument(<span style=color:#e6db74>&#34;--delay&#34;</span>, type<span style=color:#f92672>=</span>int, default<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>, help<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Delay between retries in seconds&#34;</span>)
</span></span><span style=display:flex><span>args <span style=color:#f92672>=</span> parser<span style=color:#f92672>.</span>parse_args()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>proxmox <span style=color:#f92672>=</span> ProxmoxAPI(
</span></span><span style=display:flex><span>    args<span style=color:#f92672>.</span>host,
</span></span><span style=display:flex><span>    user<span style=color:#f92672>=</span>args<span style=color:#f92672>.</span>user,
</span></span><span style=display:flex><span>    token_name<span style=color:#f92672>=</span>args<span style=color:#f92672>.</span>token_name,
</span></span><span style=display:flex><span>    token_value<span style=color:#f92672>=</span>args<span style=color:#f92672>.</span>token_value,
</span></span><span style=display:flex><span>    verify_ssl<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ip_address <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> attempt <span style=color:#f92672>in</span> range(args<span style=color:#f92672>.</span>retries):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        interfaces <span style=color:#f92672>=</span> proxmox<span style=color:#f92672>.</span>nodes(args<span style=color:#f92672>.</span>node)<span style=color:#f92672>.</span>lxc(args<span style=color:#f92672>.</span>vmid)<span style=color:#f92672>.</span>interfaces<span style=color:#f92672>.</span>get()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        sys<span style=color:#f92672>.</span>stderr<span style=color:#f92672>.</span>write(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Attempt </span><span style=color:#e6db74>{</span>attempt<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span><span style=color:#e6db74>}</span><span style=color:#e6db74>: Error retrieving interfaces: </span><span style=color:#e6db74>{</span>e<span style=color:#e6db74>}</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        time<span style=color:#f92672>.</span>sleep(args<span style=color:#f92672>.</span>delay)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> interface <span style=color:#f92672>in</span> interfaces:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> interface<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;name&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;eth0&#34;</span>:
</span></span><span style=display:flex><span>            inet <span style=color:#f92672>=</span> interface<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;inet&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> inet:
</span></span><span style=display:flex><span>                ip_address <span style=color:#f92672>=</span> inet<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#34;/&#34;</span>)[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ip_address:
</span></span><span style=display:flex><span>        print(ip_address)
</span></span><span style=display:flex><span>        sys<span style=color:#f92672>.</span>exit(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        sys<span style=color:#f92672>.</span>stderr<span style=color:#f92672>.</span>write(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Attempt </span><span style=color:#e6db74>{</span>attempt<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span><span style=color:#e6db74>}</span><span style=color:#e6db74>: eth0 not found or no IP assigned. Retrying in </span><span style=color:#e6db74>{</span>args<span style=color:#f92672>.</span>delay<span style=color:#e6db74>}</span><span style=color:#e6db74> seconds...</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        time<span style=color:#f92672>.</span>sleep(args<span style=color:#f92672>.</span>delay)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sys<span style=color:#f92672>.</span>stderr<span style=color:#f92672>.</span>write(<span style=color:#e6db74>&#34;Failed to retrieve container IP address after multiple attempts.</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>sys<span style=color:#f92672>.</span>exit(<span style=color:#ae81ff>1</span>)
</span></span></code></pre></div><p>Now create the new task under <code>roles/proxmox_lxc/tasks/get_ip.yml</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Retrieve container IP via DHCP using proxmoxer</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>command</span>: &gt;<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    {{ role_path }}/files/get_container_ip.py
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    --host &#34;{{ proxmox_api_host }}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    --user &#34;{{ proxmox_api_user }}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    --token_name &#34;{{ proxmox_api_id }}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    --token_value &#34;{{ proxmox_api_secret }}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    --node &#34;{{ proxmox_node }}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    --vmid &#34;{{ container.vmid }}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    --retries 10
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    --delay 3</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>register</span>: <span style=color:#ae81ff>ip_result</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>changed_when</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Set container IP fact</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>set_fact</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_ip</span>: <span style=color:#e6db74>&#34;{{ ip_result.stdout }}&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Debug task to show container IP - comment out if not needed</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Debug - Show container IP</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;Container IP is: {{ container_ip }}&#34;</span>
</span></span></code></pre></div><p>This will execute out Python script, store the IP as a fact and (optionally) output it to the terminal. Add this task to <code>main.yml</code> like so:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Retrieve container IP if flag is set</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>include_tasks</span>: <span style=color:#ae81ff>get_ip.yml</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>when</span>: <span style=color:#ae81ff>container.get_ip | default(false)</span>
</span></span></code></pre></div><p>This tells your your playbook to retrieve the container up when the <code>get_ip</code> flag is set to <code>true</code>. Try it out by stopping and starting a container with the flag set:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>lxcs</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>vmid</span>: <span style=color:#ae81ff>114</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>state</span>: <span style=color:#ae81ff>stopped</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>vmid</span>: <span style=color:#ae81ff>114</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>state</span>: <span style=color:#ae81ff>started</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>get_ip</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>You should see the following in your output.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>TASK <span style=color:#f92672>[</span>proxmox_lxc : Debug - Show container IP<span style=color:#f92672>]</span> ********************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>localhost<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;Container IP is: 192.168.1.154&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=closing>Closing<a href=#closing class=hanchor arialabel=Anchor>#</a></h2><p>It&rsquo;s late, and this is a lot longer than I originally anticipated. I&rsquo;m going to call it a wrap for part 2. In part 3, we&rsquo;ll continue configuring the fully provisioned LXCs over SSH with Ansible. I&rsquo;ll commit these changes <a href=https://github.com/sbarbett/proxmox-ansible>to GitHub</a> if you want to clone or fork the repository.</p><p>TTFN</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><a href=https://sbarbett.github.io/reticulating-splines/posts/ansible-playbooks-for-proxmox-lxcs-pt3/ class="button inline prev">Ansible Playbooks for Proxmox and LXCs Part 3
</a>::
<a href=https://sbarbett.github.io/reticulating-splines/posts/ansible-playbooks-for-proxmox-lxcs/ class="button inline next">Ansible Playbooks for Proxmox and LXCs Part 1</a></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2025 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/reticulating-splines/bundle.min.js></script></div></body></html>
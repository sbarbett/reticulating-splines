<!doctype html><html lang=en><head><title>Playing With My PiHoles :: reticulating splines</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="PiHole dropped a new release last week. Let's talk about that."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://sbarbett.github.io/reticulating-splines/posts/playing-with-my-piholes/><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/buttons.min.3be0bba9fe18b5b77c8fe97175a5ff803eb3b8d6b94a4c43e6c842bc229040f1.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/code.min.628b83582b7e3ce5fbec137a2c22e9dd728066c2a25433bc713f3c02f60e9d0d.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/fonts.min.90c955c31dd7c0e05aae3d4f583d4d8a2af799d69c961337eaf2a825063a55dd.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/footer.min.2e3eb191baee58dd05a9f0104ac1fab0827bca7c64dafe0b2579f934c33a1d69.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/header.min.b6fb4423cf82a9f9d7abc9cd010223fa3d70a6526a3f28f8e17d814c06e18f9e.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/main.min.ddc450348e2172fcf09bb193f216484ec68c51f52c43c89268b93314cb7805ae.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/menu.min.036f7f3c01b34c968c3c11f671600515ea8247bdb345694d1c244c92edc67a24.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/pagination.min.82f6400eae7c7c6dc3c866733c2ec0579e4089608fea69400ff85b3880aa0d3c.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/post.min.f22509cc505be9b59106980693175422c998445b17d3b4bb9c154dac90186ae9.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/prism.min.9023bbc24533d09e97a51a0a42a5a7bfe4c591ae167c5551fb1d2191d11977c0.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/syntax.min.28d2d93e80d9fc88428d8438285537c167ec74544ef064da1cc0313254904b54.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/terminal.min.f00ec1a3d030ac6d3aed932564fc961b9980150830dc8ef37f964f2858ccf558.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css><link rel=stylesheet href=https://sbarbett.github.io/reticulating-splines/style.css><link rel="shortcut icon" href=https://sbarbett.github.io/reticulating-splines/favicon.png><link rel=apple-touch-icon href=https://sbarbett.github.io/reticulating-splines/apple-touch-icon.png><meta name=twitter:card content="summary"><meta name=twitter:site content="https://shane.barbetta.me"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Playing With My PiHoles"><meta property="og:description" content="PiHole dropped a new release last week. Let's talk about that."><meta property="og:url" content="https://sbarbett.github.io/reticulating-splines/posts/playing-with-my-piholes/"><meta property="og:site_name" content="reticulating splines"><meta property="og:image" content="https://sbarbett.github.io/reticulating-splines/og-image.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2025-02-22 00:00:00 +0000 UTC"></head><body><div class="container full"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>reticulating splines</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=https://shane.barbetta.me>about</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=https://shane.barbetta.me>about</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://sbarbett.github.io/reticulating-splines/posts/playing-with-my-piholes/>Playing With My PiHoles</a></h1><div class=post-meta><time class=post-date>2025-02-22</time></div><span class=post-tags>#<a href=https://sbarbett.github.io/reticulating-splines/tags/pihole/>pihole</a>&nbsp;
#<a href=https://sbarbett.github.io/reticulating-splines/tags/ansible/>ansible</a>&nbsp;
#<a href=https://sbarbett.github.io/reticulating-splines/tags/python/>python</a>&nbsp;</span><div class=post-content><div><h1 id=playing-with-my-piholes>Playing With My PiHoles<a href=#playing-with-my-piholes class=hanchor arialabel=Anchor>#</a></h1><p>Last weekend, the PiHole team dropped a major update – PiHole v6. This version completely re-architects the project. They’ve updated the web server, overhauled the APIs and interface, and added a few new features. It looks pretty solid on paper, but I’m not ready to roll it out on my production Raspberry Pis until I’m sure all the kinks are worked out. From what I’m seeing on Reddit, there’s still plenty to fix. That won’t stop me from tinkering, though.</p><h2 id=how-i-manage-my-home-dns>How I Manage My Home DNS<a href=#how-i-manage-my-home-dns class=hanchor arialabel=Anchor>#</a></h2><p>I run a home lab with a mix of bare-metal Linux servers and a Proxmox host where all my LXCs live. With so many devices and IPs, memorizing them isn’t an option. That’s why I use PiHole’s Local DNS to handle hostnames.</p><p>To date, I’ve been setting these records manually via the web interface. Here’s what I’m aiming for:</p><ol><li>A script I can run from my laptop that automatically provisions a new local CNAME or A record on both PiHoles at nearly the same time.</li><li>A setup where one PiHole is primary and the other secondary, syncing changes automatically. Ideally, this sync would be idempotent so that no unnecessary changes are forced.</li></ol><p>With all these API changes, it’s the perfect time to work on a strategy.</p><h2 id=the-pihole-api>The PiHole API<a href=#the-pihole-api class=hanchor arialabel=Anchor>#</a></h2><p>The updated API is actually pretty well-structured.</p><p><img src=/img/pihole-api-screenshot.jpg alt="Screenshot of VNICs"></p><p>The configuration section was a bit confusing at first, but you get the hang of it. I plan to use Ansible to manage my setup, which means I need a way to handle connections to the API through a module.</p><h3 id=python-sdk>Python SDK<a href=#python-sdk class=hanchor arialabel=Anchor>#</a></h3><p>I decided to write a little SDK for the PiHole API. If you want to try it out, you can download it from PyPi:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>pip install pihole6api
</span></span></code></pre></div><p>You can also check out <a href=https://github.com/sbarbett/pihole6api>the source code on GitHub</a>. The client is built from two main components:</p><ol><li><strong>The connection module:</strong> This handles authentication, stores the connection state and closes the session when you’re done.</li><li><strong>The client:</strong> This wraps all the API endpoints. The API is organized into submodules so that each section of the API is handled by a dedicated part of the client.</li></ol><h4 id=usage>Usage<a href=#usage class=hanchor arialabel=Anchor>#</a></h4><p><strong>Instantiate a Client:</strong></p><p>Just pass your PiHole URL and password into the constructor:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> pihole6api <span style=color:#f92672>import</span> PiHole6Client
</span></span><span style=display:flex><span>client <span style=color:#f92672>=</span> PiHole6Client(<span style=color:#e6db74>&#34;https://test-pihole.example.me&#34;</span>, <span style=color:#e6db74>&#34;correct horse battery staple&#34;</span>)
</span></span></code></pre></div><p><strong>Submodules:</strong></p><p>The client is split into submodules based on the API documentation. If you’re working in the CLI, a quick way to see what methods are available is by using the <code>dir()</code> function:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>print(dir(client))
</span></span></code></pre></div><p>This will list all the object’s properties (the ones that start and end with <code>__</code> are Python’s magic methods).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>[
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;__class__&#34;</span>,
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;...&#34;</span>,
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;__weakref__&#34;</span>,
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;actions&#34;</span>,
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;client_management&#34;</span>,
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;close_session&#34;</span>,
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;config&#34;</span>,
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;connection&#34;</span>,
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;dhcp&#34;</span>,
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;dns_control&#34;</span>,
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;domain_management&#34;</span>,
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;ftl_info&#34;</span>,
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;get_padd_summary&#34;</span>,
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;group_management&#34;</span>,
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;list_management&#34;</span>,
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;metrics&#34;</span>,
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;network_info&#34;</span>
</span></span><span style=display:flex><span>]
</span></span></code></pre></div><p>To inspect a specific submodule, try:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>print(dir(client<span style=color:#f92672>.</span>metrics))
</span></span></code></pre></div><p>This will show you the available methods in the <code>metrics</code> submodule.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>[
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;...&#34;</span>,
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;connection&#34;</span>,
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;get_history&#34;</span>,
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;get_history_clients&#34;</span>,
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;get_history_database&#34;</span>,
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;get_history_database_clients&#34;</span>,
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;get_queries&#34;</span>,
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;get_query_suggestions&#34;</span>,
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;get_stats_database_query_types&#34;</span>,
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;get_stats_database_summary&#34;</span>,
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;get_stats_database_top_clients&#34;</span>,
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;get_stats_database_top_domains&#34;</span>,
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;get_stats_database_upstreams&#34;</span>,
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;get_stats_query_types&#34;</span>,
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;get_stats_recent_blocked&#34;</span>,
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;get_stats_summary&#34;</span>,
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;get_stats_top_clients&#34;</span>,
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;get_stats_top_domains&#34;</span>,
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;get_stats_upstreams&#34;</span>
</span></span><span style=display:flex><span>]
</span></span></code></pre></div><p><strong>View Queries:</strong></p><p>As a simple test, you can view some queries with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>print(client<span style=color:#f92672>.</span>metrics<span style=color:#f92672>.</span>get_queries())
</span></span></code></pre></div><p>This call returns a dictionary with your query data. For example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>{
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;cursor&#34;</span>: <span style=color:#ae81ff>14</span>,
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;draw&#34;</span>: <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;queries&#34;</span>: [
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>         <span style=color:#e6db74>&#34;client&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;ip&#34;</span>: <span style=color:#e6db74>&#34;127.0.0.1&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;localhost&#34;</span>
</span></span><span style=display:flex><span>         },
</span></span><span style=display:flex><span>         <span style=color:#e6db74>&#34;cname&#34;</span>: null,
</span></span><span style=display:flex><span>         <span style=color:#e6db74>&#34;dnssec&#34;</span>: <span style=color:#e6db74>&#34;UNKNOWN&#34;</span>,
</span></span><span style=display:flex><span>         <span style=color:#e6db74>&#34;domain&#34;</span>: <span style=color:#e6db74>&#34;1.0.0.127.in-addr.arpa&#34;</span>,
</span></span><span style=display:flex><span>         <span style=color:#e6db74>&#34;ede&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;code&#34;</span>: <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;text&#34;</span>: null
</span></span><span style=display:flex><span>         },
</span></span><span style=display:flex><span>         <span style=color:#e6db74>&#34;id&#34;</span>: <span style=color:#ae81ff>14</span>,
</span></span><span style=display:flex><span>         <span style=color:#e6db74>&#34;list_id&#34;</span>: null,
</span></span><span style=display:flex><span>         <span style=color:#e6db74>&#34;reply&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;time&#34;</span>: <span style=color:#ae81ff>0.00006198883056640625</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;DOMAIN&#34;</span>
</span></span><span style=display:flex><span>         },
</span></span><span style=display:flex><span>         <span style=color:#e6db74>&#34;status&#34;</span>: <span style=color:#e6db74>&#34;CACHE&#34;</span>,
</span></span><span style=display:flex><span>         <span style=color:#e6db74>&#34;time&#34;</span>: <span style=color:#ae81ff>1740790800.3022587</span>,
</span></span><span style=display:flex><span>         <span style=color:#e6db74>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;PTR&#34;</span>,
</span></span><span style=display:flex><span>         <span style=color:#e6db74>&#34;upstream&#34;</span>: null
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>         <span style=color:#e6db74>&#34;client&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;ip&#34;</span>: <span style=color:#e6db74>&#34;127.0.0.1&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;localhost&#34;</span>
</span></span><span style=display:flex><span>         },
</span></span><span style=display:flex><span>         <span style=color:#e6db74>&#34;cname&#34;</span>: null,
</span></span><span style=display:flex><span>         <span style=color:#e6db74>&#34;dnssec&#34;</span>: <span style=color:#e6db74>&#34;UNKNOWN&#34;</span>,
</span></span><span style=display:flex><span>         <span style=color:#e6db74>&#34;domain&#34;</span>: <span style=color:#e6db74>&#34;211.1.168.192.in-addr.arpa&#34;</span>,
</span></span><span style=display:flex><span>         <span style=color:#e6db74>&#34;ede&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;code&#34;</span>: <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;text&#34;</span>: null
</span></span><span style=display:flex><span>         },
</span></span><span style=display:flex><span>         <span style=color:#e6db74>&#34;id&#34;</span>: <span style=color:#ae81ff>13</span>,
</span></span><span style=display:flex><span>         <span style=color:#e6db74>&#34;list_id&#34;</span>: null,
</span></span><span style=display:flex><span>         <span style=color:#e6db74>&#34;reply&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;time&#34;</span>: <span style=color:#ae81ff>0.0000133514404296875</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;NXDOMAIN&#34;</span>
</span></span><span style=display:flex><span>         },
</span></span><span style=display:flex><span>         <span style=color:#e6db74>&#34;status&#34;</span>: <span style=color:#e6db74>&#34;CACHE&#34;</span>,
</span></span><span style=display:flex><span>         <span style=color:#e6db74>&#34;time&#34;</span>: <span style=color:#ae81ff>1740787200.5384429</span>,
</span></span><span style=display:flex><span>         <span style=color:#e6db74>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;PTR&#34;</span>,
</span></span><span style=display:flex><span>         <span style=color:#e6db74>&#34;upstream&#34;</span>: null
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      {<span style=color:#e6db74>&#34;...&#34;</span>:<span style=color:#e6db74>&#34;...&#34;</span>}
</span></span><span style=display:flex><span>   ],
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;recordsFiltered&#34;</span>: <span style=color:#ae81ff>14</span>,
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;recordsTotal&#34;</span>: <span style=color:#ae81ff>14</span>,
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;took&#34;</span>: <span style=color:#ae81ff>0.00010728836059570312</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>That’s the basic rundown of the Python SDK. From here, you can explore the other submodules to see how the client handles different parts of the API.</p><h2 id=making-a-collection-of-ansible-modules>Making a Collection of Ansible Modules<a href=#making-a-collection-of-ansible-modules class=hanchor arialabel=Anchor>#</a></h2><p>You can check out my full Ansible collection on <a href=https://github.com/sbarbett/pihole-ansible>GitHub</a>.</p><p>Now that all the API endpoints are wrapped in a Python client, we can plug that into Ansible modules. To get started, I created the basic structure of an Ansible collection with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible collection init namespace.collection_name
</span></span></code></pre></div><p>This will generated a directory structure like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>current_directory
</span></span><span style=display:flex><span>L namespace/
</span></span><span style=display:flex><span>L L collection_name/
</span></span><span style=display:flex><span>L L L docs/
</span></span><span style=display:flex><span>L L L meta/
</span></span><span style=display:flex><span>L L L plugins/
</span></span><span style=display:flex><span>L L L roles/
</span></span><span style=display:flex><span>L L L README.md
</span></span><span style=display:flex><span>L L L galaxy.yml
</span></span></code></pre></div><p>Inside the <code>plugins/</code> directory, I created a folder called <code>modules/</code> where I put my module files.</p><h3 id=writing-a-module>Writing a Module<a href=#writing-a-module class=hanchor arialabel=Anchor>#</a></h3><p>A substantial portion of the module code is documentation.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/python</span>
</span></span><span style=display:flex><span><span style=color:#75715e># -*- coding: utf-8 -*-</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> ansible.module_utils.basic <span style=color:#f92672>import</span> AnsibleModule
</span></span><span style=display:flex><span><span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>from</span> pihole6api <span style=color:#f92672>import</span> PiHole6Client
</span></span><span style=display:flex><span><span style=color:#66d9ef>except</span> <span style=color:#a6e22e>ImportError</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>ImportError</span>(<span style=color:#e6db74>&#34;The &#39;pihole6api&#39; Python module is required. Run &#39;pip install pihole6api&#39; to install it.&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DOCUMENTATION <span style=color:#f92672>=</span> <span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>---
</span></span></span><span style=display:flex><span><span style=color:#e6db74>module: local_a_record
</span></span></span><span style=display:flex><span><span style=color:#e6db74>short_description: Manage Pi-hole local A records via pihole v6 API.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>description:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - This module adds or removes local A records on a Pi-hole instance using the piholev6api Python client.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>options:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    host:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        description:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            - The hostname for the A record.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        required: true
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        type: str
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    ip:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        description:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            - The IP address to associate with the hostname.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        required: true
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        type: str
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    state:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        description:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            - Whether the A record should be present or absent.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        required: true
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        type: str
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        choices: [&#39;present&#39;, &#39;absent&#39;]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    password:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        description:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            - The API password for the Pi-hole instance.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        required: true
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        type: str
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        no_log: true
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    url:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        description:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            - The URL of the Pi-hole instance.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        required: true
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        type: str
</span></span></span><span style=display:flex><span><span style=color:#e6db74>author:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - Shane Barbetta (@sbarbett)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>EXAMPLES <span style=color:#f92672>=</span> <span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- name: Create test.example.com A record
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  sbarbett.pihole.local_a_record:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    host: test.example.com
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    ip: 127.0.0.1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    state: present
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    url: &#34;https://your-pihole.example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    password: &#34;{{ pihole_password }}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- name: Delete test.example.com A record
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  sbarbett.pihole.local_a_record:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    host: test.example.com
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    ip: 127.0.0.1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    state: absent
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    url: &#34;https://your-pihole.example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    password: &#34;{{ pihole_password }}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>RETURN <span style=color:#f92672>=</span> <span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>result:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    description: The API response from the Pi-hole server.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    type: dict
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    returned: always
</span></span></span><span style=display:flex><span><span style=color:#e6db74>changed:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    description: Whether any change was made.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    type: bool
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    returned: always
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#39;&#39;&#39;</span>
</span></span></code></pre></div><p>This module lets you create or delete an A record on your PiHole by simply setting the state to <code>present</code> or <code>absent</code>. It checks whether a record already exists and ensures changes are only made when necessary.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run_module</span>():
</span></span><span style=display:flex><span>    module_args <span style=color:#f92672>=</span> dict(
</span></span><span style=display:flex><span>        host<span style=color:#f92672>=</span>dict(type<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;str&#39;</span>, required<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>),
</span></span><span style=display:flex><span>        ip<span style=color:#f92672>=</span>dict(type<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;str&#39;</span>, required<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>),
</span></span><span style=display:flex><span>        state<span style=color:#f92672>=</span>dict(type<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;str&#39;</span>, choices<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;present&#39;</span>, <span style=color:#e6db74>&#39;absent&#39;</span>], required<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>),
</span></span><span style=display:flex><span>        password<span style=color:#f92672>=</span>dict(type<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;str&#39;</span>, required<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, no_log<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>),
</span></span><span style=display:flex><span>        url<span style=color:#f92672>=</span>dict(type<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;str&#39;</span>, required<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    result <span style=color:#f92672>=</span> dict(
</span></span><span style=display:flex><span>        changed<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>,
</span></span><span style=display:flex><span>        result<span style=color:#f92672>=</span>{}
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    module <span style=color:#f92672>=</span> AnsibleModule(
</span></span><span style=display:flex><span>        argument_spec<span style=color:#f92672>=</span>module_args,
</span></span><span style=display:flex><span>        supports_check_mode<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    host <span style=color:#f92672>=</span> module<span style=color:#f92672>.</span>params[<span style=color:#e6db74>&#39;host&#39;</span>]
</span></span><span style=display:flex><span>    ip <span style=color:#f92672>=</span> module<span style=color:#f92672>.</span>params[<span style=color:#e6db74>&#39;ip&#39;</span>]
</span></span><span style=display:flex><span>    state <span style=color:#f92672>=</span> module<span style=color:#f92672>.</span>params[<span style=color:#e6db74>&#39;state&#39;</span>]
</span></span><span style=display:flex><span>    password <span style=color:#f92672>=</span> module<span style=color:#f92672>.</span>params[<span style=color:#e6db74>&#39;password&#39;</span>]
</span></span><span style=display:flex><span>    url <span style=color:#f92672>=</span> module<span style=color:#f92672>.</span>params[<span style=color:#e6db74>&#39;url&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> module<span style=color:#f92672>.</span>check_mode:
</span></span><span style=display:flex><span>        module<span style=color:#f92672>.</span>exit_json(<span style=color:#f92672>**</span>result)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        client <span style=color:#f92672>=</span> PiHole6Client(url, password)
</span></span><span style=display:flex><span>        current_config <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span>config<span style=color:#f92672>.</span>get_config_section(<span style=color:#e6db74>&#34;dns/hosts&#34;</span>)
</span></span><span style=display:flex><span>        hosts_list <span style=color:#f92672>=</span> current_config<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;config&#34;</span>, {})<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;dns&#34;</span>, {})<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;hosts&#34;</span>, [])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        existing_ip <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> entry <span style=color:#f92672>in</span> hosts_list:
</span></span><span style=display:flex><span>            parts <span style=color:#f92672>=</span> entry<span style=color:#f92672>.</span>split(<span style=color:#66d9ef>None</span>, <span style=color:#ae81ff>1</span>)  <span style=color:#75715e># expected format: &#34;ip host&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> len(parts) <span style=color:#f92672>==</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>and</span> parts[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>==</span> host:
</span></span><span style=display:flex><span>                existing_ip <span style=color:#f92672>=</span> parts[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> state <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;present&#39;</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> existing_ip <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>                <span style=color:#75715e># No record exists; add the new one.</span>
</span></span><span style=display:flex><span>                add_response <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span>config<span style=color:#f92672>.</span>add_local_a_record(host, ip)
</span></span><span style=display:flex><span>                result[<span style=color:#e6db74>&#39;changed&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>                result[<span style=color:#e6db74>&#39;result&#39;</span>] <span style=color:#f92672>=</span> add_response
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>elif</span> existing_ip <span style=color:#f92672>!=</span> ip:
</span></span><span style=display:flex><span>                <span style=color:#75715e># A record exists but with a different IP; remove it first.</span>
</span></span><span style=display:flex><span>                remove_response <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span>config<span style=color:#f92672>.</span>remove_local_a_record(host, existing_ip)
</span></span><span style=display:flex><span>                add_response <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span>config<span style=color:#f92672>.</span>add_local_a_record(host, ip)
</span></span><span style=display:flex><span>                result[<span style=color:#e6db74>&#39;changed&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>                result[<span style=color:#e6db74>&#39;result&#39;</span>] <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#39;removed&#39;</span>: remove_response, <span style=color:#e6db74>&#39;added&#39;</span>: add_response}
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>                result[<span style=color:#e6db74>&#39;changed&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>                result[<span style=color:#e6db74>&#39;result&#39;</span>] <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;Record already exists with the desired IP&#34;</span>, <span style=color:#e6db74>&#34;current&#34;</span>: current_config}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>elif</span> state <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;absent&#39;</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> existing_ip <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>                remove_response <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span>config<span style=color:#f92672>.</span>remove_local_a_record(host, existing_ip)
</span></span><span style=display:flex><span>                result[<span style=color:#e6db74>&#39;changed&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>                result[<span style=color:#e6db74>&#39;result&#39;</span>] <span style=color:#f92672>=</span> remove_response
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>                result[<span style=color:#e6db74>&#39;changed&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>                result[<span style=color:#e6db74>&#39;result&#39;</span>] <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;Record does not exist&#34;</span>, <span style=color:#e6db74>&#34;current&#34;</span>: current_config}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        module<span style=color:#f92672>.</span>exit_json(<span style=color:#f92672>**</span>result)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        module<span style=color:#f92672>.</span>fail_json(msg<span style=color:#f92672>=</span><span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Error managing local A record: </span><span style=color:#e6db74>{</span>e<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>, <span style=color:#f92672>**</span>result)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>finally</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> client <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>            client<span style=color:#f92672>.</span>close_session()
</span></span></code></pre></div><p><strong>An important note regarding the PiHole API and active &ldquo;sessions&rdquo;</strong>: There are only a limited number of &ldquo;seats&rdquo; available for sessions. You must close or delete your sessions once you’re finished with them. If you don’t, especially when running things in Ansible, orphaned sessions can quickly accumulate, and eventually your PiHole will lock you out due to too many active sessions.</p><h3 id=writing-a-playbook>Writing a Playbook<a href=#writing-a-playbook class=hanchor arialabel=Anchor>#</a></h3><p>You can call a module from within a playbook like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Create test.example.com A record</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>localhost</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gather_facts</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Create test.example.com A record</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>sbarbett.pihole.local_a_record</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>host</span>: <span style=color:#ae81ff>test.example.com</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>ip</span>: <span style=color:#ae81ff>127.0.0.2</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>url</span>: <span style=color:#e6db74>&#34;https://your-pihole.example.com&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>password</span>: <span style=color:#e6db74>&#34;{{ pihole_password }}&#34;</span>
</span></span></code></pre></div><p>And to delete the record:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Delete test.example.com A record</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>localhost</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gather_facts</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Delete test.example.com A record</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>sbarbett.pihole.local_a_record</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>host</span>: <span style=color:#ae81ff>test.example.com</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>ip</span>: <span style=color:#ae81ff>127.0.0.1</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>absent</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>url</span>: <span style=color:#e6db74>&#34;https://your-pihole.example.com&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>password</span>: <span style=color:#e6db74>&#34;{{ pihole_password }}&#34;</span>
</span></span></code></pre></div><h3 id=adding-modules-to-a-role>Adding Modules to a Role<a href=#adding-modules-to-a-role class=hanchor arialabel=Anchor>#</a></h3><p>Keep your modules simple and focused. If you need to handle more complex configurations, break the task into individual modules and then combine them into a role. For example, if you want to define all your A records and CNAMEs in one manifest and deploy that DNS configuration to multiple PiHoles, your manifest might look like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Manage Pi-hole local records</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>localhost</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gather_facts</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>roles</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>role</span>: <span style=color:#ae81ff>sbarbett.pihole.manage_local_records</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>vars</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>pihole_hosts</span>:
</span></span><span style=display:flex><span>          - <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;https://your-pihole-1.example.com&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>password</span>: <span style=color:#e6db74>&#34;{{ pihole_password }}&#34;</span>
</span></span><span style=display:flex><span>          - <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;https://your-pihole-2.example.com&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>password</span>: <span style=color:#e6db74>&#34;{{ pihole_password }}&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>pihole_records</span>:
</span></span><span style=display:flex><span>          - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>dummy1.xyz</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>type</span>: <span style=color:#ae81ff>A</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>data</span>: <span style=color:#ae81ff>192.168.1.1</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>state</span>: <span style=color:#ae81ff>absent</span>
</span></span><span style=display:flex><span>          - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>dummy2.xyz</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>type</span>: <span style=color:#ae81ff>CNAME</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>data</span>: <span style=color:#ae81ff>dummy1.xyz</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>state</span>: <span style=color:#ae81ff>absent</span>
</span></span><span style=display:flex><span>          - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>dummy3.xyz</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>type</span>: <span style=color:#ae81ff>A</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>data</span>: <span style=color:#ae81ff>127.0.0.1</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>state</span>: <span style=color:#ae81ff>absent</span>
</span></span><span style=display:flex><span>          - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>dummy4.xyz</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>type</span>: <span style=color:#ae81ff>CNAME</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>data</span>: <span style=color:#ae81ff>dummy2.xyz</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>ttl</span>: <span style=color:#ae81ff>900</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>state</span>: <span style=color:#ae81ff>absent</span>
</span></span></code></pre></div><p>From the root of my collection, I created a basic role structure using:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible-galaxy init roles/role_name
</span></span></code></pre></div><p>Then I added my workflow logic into the <code>tasks/</code> directory. In <code>main.yml</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Process each Pi-hole instance</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>include_tasks</span>: <span style=color:#ae81ff>process_instance.yml</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>loop</span>: <span style=color:#e6db74>&#34;{{ pihole_hosts }}&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>loop_control</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>loop_var</span>: <span style=color:#ae81ff>pihole_instance</span>
</span></span></code></pre></div><p>This tells the role to loop through the list of hosts and run the <code>process_instance.yml</code> task. In <code>process_instance.yml</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Process each record on {{ pihole_instance.name }}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>include_tasks</span>: <span style=color:#ae81ff>process_record.yml</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>loop</span>: <span style=color:#e6db74>&#34;{{ pihole_records }}&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>loop_control</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>loop_var</span>: <span style=color:#ae81ff>record</span>
</span></span></code></pre></div><p>This loops through each record in the list and runs the <code>process_record.yml</code> task. Finally, in <code>process_record.yml</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Process record {{ record.name }} on {{ pihole_instance.name }}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>block</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Manage A record on {{ pihole_instance.name }}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>sbarbett.pihole.local_a_record</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>host</span>: <span style=color:#e6db74>&#34;{{ record.name }}&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>ip</span>: <span style=color:#e6db74>&#34;{{ record.data }}&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#e6db74>&#34;{{ record.state }}&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>url</span>: <span style=color:#e6db74>&#34;{{ pihole_instance.name }}&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>password</span>: <span style=color:#e6db74>&#34;{{ pihole_instance.password }}&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>when</span>: <span style=color:#ae81ff>record.type == &#34;A&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Manage CNAME record on {{ pihole_instance.name }}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>sbarbett.pihole.local_cname</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>host</span>: <span style=color:#e6db74>&#34;{{ record.name }}&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>target</span>: <span style=color:#e6db74>&#34;{{ record.data }}&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>ttl</span>: <span style=color:#e6db74>&#34;{{ record.ttl | default(300) }}&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#e6db74>&#34;{{ record.state }}&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>url</span>: <span style=color:#e6db74>&#34;{{ pihole_instance.name }}&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>password</span>: <span style=color:#e6db74>&#34;{{ pihole_instance.password }}&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>when</span>: <span style=color:#ae81ff>record.type == &#34;CNAME&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Pause for 1 second</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>command</span>: <span style=color:#ae81ff>sleep 1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>changed_when</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>no_log</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>In this final task file, the role handles creating an A record or a CNAME, based on the record type, and then pauses for a second to avoid overloading the PiHole and triggering any rate limits.</p><h2 id=proxmox-role>Proxmox Role<a href=#proxmox-role class=hanchor arialabel=Anchor>#</a></h2><p>I added a flag to the <code>docker_compose</code> role in my <a href=https://github.com/sbarbett/proxmox-ansible>Proxmox collection</a> that automatically installs PiHole and Unbound together, with Unbound set up as the upstream resolver.</p><h2 id=tying-it-all-together>Tying It All Together<a href=#tying-it-all-together class=hanchor arialabel=Anchor>#</a></h2><p>To set up Ansible in a self-contained virtual environment, use this shell script:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>set -e  <span style=color:#75715e># Exit on error</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Define directories</span>
</span></span><span style=display:flex><span>BASE_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>pwd<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>SECRETS_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$HOME<span style=color:#e6db74>/.secrets&#34;</span>
</span></span><span style=display:flex><span>TIMESTAMP<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>date +%s<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>VAULT_PASSWORD_FILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$SECRETS_DIR<span style=color:#e6db74>/.vault-password-</span>$TIMESTAMP<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>ANSIBLE_CFG<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$BASE_DIR<span style=color:#e6db74>/ansible.cfg&#34;</span>
</span></span><span style=display:flex><span>INVENTORY_FILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$BASE_DIR<span style=color:#e6db74>/hosts&#34;</span>
</span></span><span style=display:flex><span>VAULT_FILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$BASE_DIR<span style=color:#e6db74>/group_vars/test_servers/vault&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Create sandbox environment</span>
</span></span><span style=display:flex><span>mkdir -p <span style=color:#e6db74>&#34;</span>$BASE_DIR<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>cd <span style=color:#e6db74>&#34;</span>$BASE_DIR<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Set up Python virtual environment</span>
</span></span><span style=display:flex><span>python3 -m venv venv
</span></span><span style=display:flex><span>source venv/bin/activate
</span></span><span style=display:flex><span>pip install --upgrade pip
</span></span><span style=display:flex><span>pip install ansible requests pihole6api proxmoxer passlib
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Verify installation</span>
</span></span><span style=display:flex><span>ansible --version
</span></span><span style=display:flex><span>ansible-community --version
</span></span><span style=display:flex><span>which ansible
</span></span><span style=display:flex><span>which python
</span></span><span style=display:flex><span>PYTHON_BIN<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>which python<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Initialize ansible.cfg</span>
</span></span><span style=display:flex><span>ansible-config init --disabled &gt; <span style=color:#e6db74>&#34;</span>$ANSIBLE_CFG<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Update ansible.cfg</span>
</span></span><span style=display:flex><span>sed -i <span style=color:#e6db74>&#34;s|;vault_password_file=.*|vault_password_file=</span>$VAULT_PASSWORD_FILE<span style=color:#e6db74>|&#34;</span> <span style=color:#e6db74>&#34;</span>$ANSIBLE_CFG<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>sed -i <span style=color:#e6db74>&#34;s|;inventory=.*|inventory=hosts|&#34;</span> <span style=color:#e6db74>&#34;</span>$ANSIBLE_CFG<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>sed -i <span style=color:#e6db74>&#39;s|;roles_path=.*|roles_path=roles|&#39;</span> <span style=color:#e6db74>&#34;</span>$ANSIBLE_CFG<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>sed -i <span style=color:#e6db74>&#39;s|;collections_path=.*|collections_path=collections|&#39;</span> <span style=color:#e6db74>&#34;</span>$ANSIBLE_CFG<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>sed -i <span style=color:#e6db74>&#39;s|;host_key_checking=True|host_key_checking=False|&#39;</span> <span style=color:#e6db74>&#34;</span>$ANSIBLE_CFG<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>sed -i <span style=color:#e6db74>&#39;s|;stdout_callback=.*|stdout_callback=unixy|&#39;</span> <span style=color:#e6db74>&#34;</span>$ANSIBLE_CFG<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>sed -i <span style=color:#e6db74>&#39;s|;vault_password_file=.*|vault_password_file=$VAULT_PASSWORD_FILE|&#39;</span> <span style=color:#e6db74>&#34;</span>$ANSIBLE_CFG<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Create necessary directories and files</span>
</span></span><span style=display:flex><span>mkdir -p <span style=color:#e6db74>&#34;</span>$BASE_DIR<span style=color:#e6db74>/roles&#34;</span> <span style=color:#e6db74>&#34;</span>$BASE_DIR<span style=color:#e6db74>/collections&#34;</span> <span style=color:#e6db74>&#34;</span>$BASE_DIR<span style=color:#e6db74>/group_vars/test_servers&#34;</span>
</span></span><span style=display:flex><span>echo -e <span style=color:#e6db74>&#34;[test_servers]\nlocalhost ansible_connection=local ansible_python_interpreter=</span>$PYTHON_BIN<span style=color:#e6db74>&#34;</span> &gt; <span style=color:#e6db74>&#34;</span>$INVENTORY_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Set up secrets directory</span>
</span></span><span style=display:flex><span>mkdir -p <span style=color:#e6db74>&#34;</span>$SECRETS_DIR<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>chmod <span style=color:#ae81ff>700</span> <span style=color:#e6db74>&#34;</span>$SECRETS_DIR<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Prompt for vault password</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> true; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;Enter a password for the Ansible Vault: &#34;</span>
</span></span><span style=display:flex><span>    read -s VAULT_PASS1
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;Confirm the password: &#34;</span>
</span></span><span style=display:flex><span>    read -s VAULT_PASS2
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$VAULT_PASS1<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;</span>$VAULT_PASS2<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        VAULT_PASS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$VAULT_PASS1<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        break
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;Passwords do not match. Please try again.&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;</span>$VAULT_PASS<span style=color:#e6db74>&#34;</span> &gt; <span style=color:#e6db74>&#34;</span>$VAULT_PASSWORD_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>chmod <span style=color:#ae81ff>600</span> <span style=color:#e6db74>&#34;</span>$VAULT_PASSWORD_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Reload vault password file to ensure it&#39;s available</span>
</span></span><span style=display:flex><span>export ANSIBLE_VAULT_PASSWORD_FILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$VAULT_PASSWORD_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Prompt for sensitive values</span>
</span></span><span style=display:flex><span>declare -A secrets
</span></span><span style=display:flex><span>secrets<span style=color:#f92672>[</span>proxmox_api_host<span style=color:#f92672>]=</span><span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>secrets<span style=color:#f92672>[</span>proxmox_api_user<span style=color:#f92672>]=</span><span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>secrets<span style=color:#f92672>[</span>proxmox_node<span style=color:#f92672>]=</span><span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>secrets<span style=color:#f92672>[</span>proxmox_api_id<span style=color:#f92672>]=</span><span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>secrets<span style=color:#f92672>[</span>proxmox_api_secret<span style=color:#f92672>]=</span><span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>secrets<span style=color:#f92672>[</span>pihole_password<span style=color:#f92672>]=</span><span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> key in <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>!secrets[@]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    echo -n <span style=color:#e6db74>&#34;Enter value for </span>$key<span style=color:#e6db74>: &#34;</span>
</span></span><span style=display:flex><span>    read value
</span></span><span style=display:flex><span>    secrets<span style=color:#f92672>[</span>$key<span style=color:#f92672>]=</span>$value
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;</span>$key<span style=color:#e6db74> set to: </span><span style=color:#e6db74>${</span>secrets[$key]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Create vault file</span>
</span></span><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt;EOF &gt; &#34;$VAULT_FILE&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>$(for key in &#34;${!secrets[@]}&#34;; do echo &#34;$key: \&#34;${secrets[$key]}\&#34;&#34;; done)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Encrypt vault file and verify encryption success</span>
</span></span><span style=display:flex><span>ansible-vault encrypt <span style=color:#e6db74>&#34;</span>$VAULT_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> $? -ne <span style=color:#ae81ff>0</span> <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;Vault encryption failed! Exiting.&#34;</span>
</span></span><span style=display:flex><span>    exit <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Verify setup</span>
</span></span><span style=display:flex><span>ansible test_servers -m ping
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Install required Ansible collections and roles</span>
</span></span><span style=display:flex><span>ansible-galaxy collection install sbarbett.proxmox_management
</span></span><span style=display:flex><span>ansible-galaxy collection install sbarbett.pihole
</span></span><span style=display:flex><span>ansible-galaxy role install geerlingguy.docker
</span></span><span style=display:flex><span>ansible-galaxy collection install community.general --upgrade
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;Ansible test environment setup complete!&#34;</span>
</span></span></code></pre></div><h3 id=usage-1>Usage<a href=#usage-1 class=hanchor arialabel=Anchor>#</a></h3><ol><li><p>Create a directory for your Ansible environment, e.g., <code>mkdir ~/ansible-test</code>.</p></li><li><p>Save the script above as <code>setup.sh</code>.</p></li><li><p>Make it executable:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>chmod +x setup.sh
</span></span></code></pre></div></li><li><p>Run the script:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./setup.sh
</span></span></code></pre></div></li></ol><p>This sets up a virtual environment, installs Ansible and dependencies, creates your inventory and configuration files, and sets up your vault.</p><h3 id=playbook-and-variables>Playbook and Variables<a href=#playbook-and-variables class=hanchor arialabel=Anchor>#</a></h3><p>Define your LXC settings in <code>group_vars/test_servers/vars.yml</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>lxcs</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>vmid</span>: <span style=color:#ae81ff>136</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>hostname</span>: <span style=color:#ae81ff>auto-pihole-test</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ostemplate</span>: <span style=color:#e6db74>&#34;local:vztmpl/debian-12-standard_12.7-1_amd64.tar.zst&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>storage</span>: <span style=color:#e6db74>&#34;local-lvm&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>cores</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>memory</span>: <span style=color:#ae81ff>1024</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>swap</span>: <span style=color:#ae81ff>512</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>disk</span>: <span style=color:#e6db74>&#34;local-lvm:25&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>net</span>: <span style=color:#e6db74>&#34;name=eth0,bridge=vmbr0,ip=dhcp&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>password</span>: <span style=color:#e6db74>&#34;containerpassword&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>onboot</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>pubkey_file</span>: <span style=color:#e6db74>&#34;~/.ssh/nuc_rsa.pub&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>features</span>: <span style=color:#e6db74>&#34;nesting=1&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Additional configuration</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>config</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>username</span>: <span style=color:#ae81ff>demo</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>user_password</span>: <span style=color:#e6db74>&#34;demo&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>private_key</span>: <span style=color:#e6db74>&#34;~/.ssh/nuc_rsa&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>wait_for_status</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>initial_setup</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>install_extras</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>install_docker</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>docker_containers</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>pihole-unbound</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>pihole_web_api_password</span>: <span style=color:#e6db74>&#34;{{ pihole_password }}&#34;</span>
</span></span></code></pre></div><p>Adjust these values to suit your needs and environment. Next, create a directory called <code>playbooks</code> and a file named <code>pihole-setup.yml</code>. This playbook provisions the LXC and sets up Pi-hole:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Provision Proxmox LXC containers</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>localhost</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>connection</span>: <span style=color:#ae81ff>local</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gather_facts</span>: <span style=color:#66d9ef>no</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Run proxmox_provision role for each container</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>include_role</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>sbarbett.proxmox_management.proxmox_provision</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>vars</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>container</span>: <span style=color:#e6db74>&#34;{{ item }}&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>loop</span>: <span style=color:#e6db74>&#34;{{ lxcs }}&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Populate dynamic inventory with container hosts</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>localhost</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>connection</span>: <span style=color:#ae81ff>local</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gather_facts</span>: <span style=color:#66d9ef>no</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Run container_setup inventory tasks for each container</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>include_role</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>sbarbett.proxmox_management.container_inventory</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>tasks_from</span>: <span style=color:#ae81ff>inventory.yml</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>vars</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>container</span>: <span style=color:#e6db74>&#34;{{ item }}&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>loop</span>: <span style=color:#e6db74>&#34;{{ lxcs }}&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Run initial container setup</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>proxmox_containers</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gather_facts</span>: <span style=color:#66d9ef>no</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>become</span>: <span style=color:#66d9ef>yes</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>roles</span>: 
</span></span><span style=display:flex><span>    - <span style=color:#f92672>role</span>: <span style=color:#ae81ff>sbarbett.proxmox_management.container_setup</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Run extras configuration on containers</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>proxmox_containers_extras</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gather_facts</span>: <span style=color:#66d9ef>yes</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>become</span>: <span style=color:#66d9ef>yes</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>roles</span>: 
</span></span><span style=display:flex><span>    - <span style=color:#f92672>role</span>: <span style=color:#ae81ff>sbarbett.proxmox_management.container_extras</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Run docker setup on provisioned containers</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>proxmox_containers_docker</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gather_facts</span>: <span style=color:#66d9ef>yes</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>roles</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>role</span>: <span style=color:#ae81ff>geerlingguy.docker</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>vars</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>docker_edition</span>: <span style=color:#e6db74>&#39;ce&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>docker_service_state</span>: <span style=color:#ae81ff>started</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>docker_service_enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>docker_packages</span>:
</span></span><span style=display:flex><span>          - <span style=color:#e6db74>&#34;docker-{{ docker_edition }}&#34;</span>
</span></span><span style=display:flex><span>          - <span style=color:#e6db74>&#34;docker-{{ docker_edition }}-cli&#34;</span>
</span></span><span style=display:flex><span>          - <span style=color:#e6db74>&#34;docker-{{ docker_edition }}-rootless-extras&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>docker_packages_state</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>docker_install_compose_plugin</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>docker_compose_package</span>: <span style=color:#ae81ff>docker-compose-plugin</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>docker_compose_package_state</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>docker_users</span>:
</span></span><span style=display:flex><span>          - <span style=color:#e6db74>&#34;{{ container.config.username }}&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Run docker container setup on provisioned containers</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>proxmox_containers_docker</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gather_facts</span>: <span style=color:#66d9ef>yes</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>become</span>: <span style=color:#66d9ef>yes</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>roles</span>: 
</span></span><span style=display:flex><span>    - <span style=color:#f92672>role</span>: <span style=color:#ae81ff>sbarbett.proxmox_management.docker_compose</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Change the PiHole listening mode</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>proxmox_containers_docker</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gather_facts</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Load PiHole password from localhost</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>set_fact</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>pihole_password</span>: <span style=color:#e6db74>&#34;{{ hostvars[&#39;localhost&#39;][&#39;pihole_password&#39;] }}&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>delegate_to</span>: <span style=color:#ae81ff>localhost</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Change the PiHole listening mode</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>delegate_to</span>: <span style=color:#ae81ff>localhost</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>run_once</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>sbarbett.pihole.listening_mode</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>mode</span>: <span style=color:#e6db74>&#34;all&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>url</span>: <span style=color:#e6db74>&#34;http://{{ hostvars[inventory_hostname].ansible_host }}:80&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>password</span>: <span style=color:#e6db74>&#34;{{ pihole_password }}&#34;</span>
</span></span></code></pre></div><p>Run the playbook with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible-playbook playbooks/pihole-setup.yml
</span></span></code></pre></div><h3 id=test>Test<a href=#test class=hanchor arialabel=Anchor>#</a></h3><p>After the playbook completes, test your server&rsquo;s DNS resolution:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>dig @<span style=color:#f92672>{</span>ip_address<span style=color:#f92672>}</span> google.com +short
</span></span></code></pre></div><p>If successful, you should see an IP address returned. Also, check that the web interface is available at <code>http://{ip_address}/admin</code>.</p><p>Your server should also be accessible via SSH using your private key.</p><h2 id=closing>Closing<a href=#closing class=hanchor arialabel=Anchor>#</a></h2><p>I shared this collection and client on the PiHole subreddit <a href=https://www.reddit.com/r/pihole/comments/1ivk5uv/i_wrote_a_python_client_for_the_v6_api/>here</a> and <a href=https://www.reddit.com/r/pihole/comments/1iw14up/ansible_collection_for_pihole_v6/>here</a>, aand the feedback was great. If there are specific automations you’d like to see added to the roles, feel free to reach out <a href=https://shane.barbetta.me/>here</a>. Good luck out there.</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><a href=https://sbarbett.github.io/reticulating-splines/posts/ansible-playbooks-for-proxmox-lxcs-pt5/ class="button inline next">Ansible Playbooks for Proxmox and LXCs Part 5</a></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2025 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/reticulating-splines/bundle.min.js></script></div></body></html>